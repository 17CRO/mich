<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Maintenance (Cloud)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioth√®que pour g√©n√©rer les QR Codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Biblioth√®que pour scanner les QR Codes -->
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    
    <!-- Police Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
        
        /* D√©finition des couleurs personnalis√©es */
        :root {
            --color-primary: #00594E; /* Vert fonc√© */
            --color-secondary: #E56A54; /* Corail/Rouge */
            --color-danger: #D9534F; /* Rouge pour suppressions/erreurs */
        }

        .bg-primary { background-color: var(--color-primary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .bg-soft { background-color: #FFFFFF; }

        .text-primary { color: var(--color-primary); }
        .text-primary-dark { color: #004238; }
        .text-secondary { color: var(--color-secondary); }
        .text-danger { color: var(--color-danger); }

        .card {
            background-color: #FFFFFF;
            border-radius: 1rem;
            box-shadow: 0 15px 45px -20px rgba(0, 89, 78, 0.35);
            border: 1px solid rgba(0, 89, 78, 0.08);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        /* Style pour le lecteur QR */
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        /* Masquer les fl√®ches sur les champs de type nombre */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Nouveaux styles pour les champs de formulaire (CSS standard) */
        .form-field {
            width: 100%;
            padding-left: 0.75rem; /* px-3 */
            padding-right: 0.75rem; /* px-3 */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            transition-property: all;
            transition-duration: 200ms;
        }
        
        .form-field:focus {
            outline: none;
            border-color: var(--color-primary);
            --tw-ring-color: var(--color-secondary);
            box-shadow: 0 0 0 2px var(--tw-ring-color);
            opacity: 0.5;
        }

        /* Am√©lioration des Select */
        .custom-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%2Mxmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20fill%3D%22none%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20stroke%3D%22%236b7280%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221.5%22%20d%3D%22M6%208l4%204%204-4%22%2F%3E%3C%2Fsvg%3E');
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem; /* Espace pour l'ic√¥ne */
        }
        
        /* Style des boutons (CSS standard) */
        .btn {
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem; /* px-4 */
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem; /* py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            color: white; /* text-white */
            transition-property: all; /* transition */
            transition-duration: 200ms; /* duration-200 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .btn-primary {
            background-color: var(--color-primary);
        }
        .btn-primary:hover {
            background-color: #004238; /* Version plus fonc√©e */
        }
        .btn-secondary {
            background-color: var(--color-secondary);
        }
        .btn-secondary:hover {
            background-color: #D9534F; /* Version plus fonc√©e */
        }
        .btn-danger {
            background-color: var(--color-danger);
        }
        .btn-danger:hover {
            background-color: #c9302c;
        }
        .btn-gray {
            background-color: #6B7280; /* Gris */
        }
        .btn-gray:hover {
             background-color: #4B5563;
        }
        
        /* Style des onglets de navigation (CSS standard) */
        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .nav-tab-active {
            background-color: var(--color-primary);
            color: white;
            border-color: rgba(0, 89, 78, 0.4);
        }
        .nav-tab-inactive {
            background-color: rgba(229, 106, 84, 0.08);
            color: var(--color-primary);
            border-color: rgba(229, 106, 84, 0.2);
        }
        .nav-tab-inactive:hover {
            background-color: rgba(229, 106, 84, 0.2);
            color: var(--color-primary);
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            border-radius: 9999px;
            padding: 0.125rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Styles pour l'impression */
        @media print {
            body * {
                visibility: hidden;
            }
            #qr-modal, #qr-modal * {
                visibility: visible;
            }
            #qr-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                padding: 0;
                margin: 0;
                max-height: none;
                overflow: visible;
            }
            #qr-modal-content {
                display: block !important; /* Permet √† la grille de s'afficher */
                overflow: visible !important;
                max-height: none !important;
            }
            .qr-grid-item {
                page-break-inside: avoid !important; /* √âviter les coupures */
                border: 1px solid #ccc;
                padding: 8px;
                margin-bottom: 8px;
            }
            .no-print {
                display: none !important;
            }
        }

        @media (max-width: 640px) {
            #main-header nav {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            #main-nav-container {
                padding-bottom: 0.75rem;
            }

            #main-nav-container .nav-tab {
                flex: 1;
                text-align: center;
            }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- En-t√™te -->
    <header id="main-header" class="bg-primary text-white shadow-md hidden">
        <nav class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-3">
                <h1 class="text-2xl font-bold tracking-tight">Gest'Appareils</h1>
                <p class="text-sm text-white/80">Gestion &amp; maintenance simplifi√©e</p>
            </div>
            <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                <span id="user-name-display" class="text-sm font-semibold hidden"></span>
                <span id="user-email-display" class="text-xs text-white/80 hidden"></span>
                <span id="user-role-display" class="badge bg-white/10 text-white hidden"></span>
                <button id="auth-button" class="btn btn-secondary text-sm py-1 px-4 shadow-none">D√©connexion</button>
            </div>
        </nav>
    </header>

    <!-- Navigation principale (Onglets) -->
    <div id="main-nav" class="bg-white/90 backdrop-blur border-b border-primary/10 sticky top-0 z-20 hidden">
        <div id="main-nav-container" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center gap-3 overflow-x-auto">
            <!-- Onglets pour tous -->
            <button id="nav-tab-scanner" data-page="scanner" class="nav-tab nav-tab-active">Scanner</button>

            <!-- Onglets Admin seulement -->
            <button id="nav-tab-reports" data-page="reports" class="nav-tab nav-tab-inactive admin-only">Rapports</button>
            <button id="nav-tab-stores" data-page="stores" class="nav-tab nav-tab-inactive admin-only">Magasins</button>
            <button id="nav-tab-forms" data-page="forms" class="nav-tab nav-tab-inactive admin-only">Formulaires</button>
            <button id="nav-tab-admin" data-page="admin" class="nav-tab nav-tab-inactive admin-only">Admin</button>
        </div>
    </div>

    <!-- Conteneur principal des pages -->
    <main id="page-container" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col gap-6">

        <!-- ================= PAGE 0: CONNEXION / INSCRIPTION ================= -->
        <div id="page-login" class="page max-w-md mx-auto card p-8">
            
            <!-- Formulaire de Connexion -->
            <form id="login-form">
                <h2 class="text-2xl font-bold text-center mb-6 text-primary-dark">Connexion</h2>
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 font-medium mb-1">Email</label>
                    <input type="email" id="login-email" class="form-field" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 font-medium mb-1">Mot de passe</label>
                    <input type="password" id="login-password" class="form-field" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">
                    Se connecter
                </button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Pas de compte ? <a href="#" id="show-signup" class="text-secondary hover:underline">Inscrivez-vous</a>
                </p>
            </form>

            <!-- Formulaire d'Inscription (cach√© par d√©faut) -->
            <form id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6 text-primary-dark">Inscription</h2>
                <div class="mb-4">
                    <label for="signup-email" class="block text-gray-700 font-medium mb-1">Email</glabel>
                    <input type="email" id="signup-email" class="form-field" required>
                </div>
                <div class="mb-6">
                    <label for="signup-password" class="block text-gray-700 font-medium mb-1">Mot de passe (6 car. min)</label>
                    <input type="password" id="signup-password" class="form-field" required>
                </div>
                <button type="submit" class="w-full btn btn-secondary">
                    Cr√©er le compte
                </button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    D√©j√† un compte ? <a href="#" id="show-login" class="text-secondary hover:underline">Connectez-vous</a>
                </p>
            </form>
        </div>

        <!-- ================= PAGE 0.5: EN ATTENTE D'APPROBATION ================= -->
        <div id="page-pending-approval" class="page hidden max-w-lg mx-auto card p-8 text-center">
            <h2 class="text-2xl font-bold text-primary-dark mb-4">Compte en attente</h2>
            <p class="text-gray-700 mb-6">Merci pour votre inscription ! Votre compte est en attente d'approbation par un administrateur. Vous serez notifi√© par email lorsque votre compte sera activ√©.</p>
            <p class="text-sm text-gray-500">Vous pouvez fermer cette page en attendant.</p>
        </div>

        <!-- ================= PAGE 0.75: PREMI√àRE CONNEXION ================= -->
        <div id="page-password-reset" class="page hidden max-w-lg mx-auto card p-8 space-y-6">
            <div class="text-center space-y-2">
                <h2 class="text-2xl font-bold text-primary-dark">Bienvenue !</h2>
                <p class="text-gray-600">C'est votre premi√®re connexion sur Gest'Appareils. Merci de personnaliser votre profil et de d√©finir un nouveau mot de passe.</p>
                <p class="text-sm text-gray-500">Connect√© en tant que <span id="force-reset-email" class="font-semibold text-primary"></span></p>
            </div>
            <form id="force-password-form" class="space-y-4">
                <div class="grid gap-4 sm:grid-cols-2">
                    <div>
                        <label for="force-first-name" class="block text-sm font-medium text-gray-700">Pr√©nom</label>
                        <input type="text" id="force-first-name" class="form-field" placeholder="ex: L√©a" required>
                    </div>
                    <div>
                        <label for="force-last-name" class="block text-sm font-medium text-gray-700">Nom</label>
                        <input type="text" id="force-last-name" class="form-field" placeholder="ex: Martin" required>
                    </div>
                </div>
                <div>
                    <label for="force-password" class="block text-sm font-medium text-gray-700">Nouveau mot de passe</label>
                    <input type="password" id="force-password" class="form-field" minlength="6" required>
                </div>
                <div>
                    <label for="force-password-confirm" class="block text-sm font-medium text-gray-700">Confirmer le mot de passe</label>
                    <input type="password" id="force-password-confirm" class="form-field" minlength="6" required>
                </div>
                <button type="submit" class="w-full btn btn-primary">Enregistrer et continuer</button>
            </form>
        </div>


        <!-- ================= PAGE 1: SCANNER ================= -->
        <div id="page-scanner" class="page hidden"> <!-- Page par d√©faut apr√®s connexion -->
            <div class="card p-6 max-w-lg mx-auto space-y-4">
                <h2 class="text-xl font-bold mb-4 text-center text-primary-dark">Scanner un QR Code</h2>
                <button id="start-scan-btn" class="w-full btn btn-primary py-3">
                    D√©marrer le Scan
                </button>
                <div id="qr-reader" class="mt-4"></div>
                <button id="stop-scan-btn" class="w-full btn btn-danger py-2 mt-4 hidden">
                    Arr√™ter le Scan
                </button>
            </div>
        </div>

        <!-- ================= PAGE 2: FORMULAIRE D'INTERVENTION ================= -->
        <div id="page-intervention-form" class="page hidden">
            <div class="card p-6 max-w-lg mx-auto space-y-4">
                <button id="back-to-scanner" class="text-secondary hover:underline mb-4">&larr; Retour au scanner</button>
                <h2 id="form-title" class="text-2xl font-bold mb-2 text-primary-dark">Rapport d'intervention</h2>
                <p id="form-subtitle" class="text-gray-600 mb-6">Veuillez remplir les champs ci-dessous.</p>
                
                <form id="intervention-form">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1">Date et Heure</label>
                        <input type="text" id="form-datetime" class="form-field bg-gray-100" readonly>
                    </div>
                    
                    <!-- Les champs dynamiques du formulaire seront inject√©s ici -->
                    <div id="dynamic-form-fields" class="space-y-4"></div>

                    <button type="submit" class="w-full btn btn-primary py-3 mt-6">
                        Soumettre le rapport
                    </button>
                </form>
            </div>
        </div>

        <!-- ================= PAGE 3: GESTION DES MAGASINS ================= -->
        <div id="page-stores" class="page hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Colonne 1: Ajouter Magasin / Appareil -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Ajouter un magasin -->
                <div class="card p-6 space-y-4">
                        <h2 class="text-xl font-bold mb-4 text-primary-dark">Ajouter un Magasin</h2>
                        <form id="add-store-form">
                            <div class="mb-4">
                                <label for="store-name" class="block text-gray-700 font-medium mb-1">Nom du Magasin</label>
                                <input type="text" id="store-name" class="form-field" required>
                            </div>
                            <div class="mb-4">
                                <label for="store-code" class="block text-gray-700 font-medium mb-1">Code Magasin (Modifiable)</label>
                                <input type="text" id="store-code" class="form-field" required>
                            </div>
                            <button type="submit" class="w-full btn btn-primary">
                                Enregistrer Magasin
                            </button>
                        </form>
                    </div>

                    <!-- Ajouter un appareil -->
                <div class="card p-6 space-y-4">
                        <h2 class="text-xl font-bold mb-4 text-primary-dark">Ajouter un Appareil</h2>
                        <form id="add-equipment-form">
                            <div class="mb-4">
                                <label for="equip-store-select" class="block text-gray-700 font-medium mb-1">Magasin</label>
                                <select id="equip-store-select" class="form-field custom-select" required>
                                    <option value="">S√©lectionnez un magasin</option>
                                    <!-- Options remplies par JS -->
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="equip-name" class="block text-gray-700 font-medium mb-1">Nom de l'appareil</label>
                                <input type="text" id="equip-name" class="form-field" placeholder="Ex: Chaudi√®re n¬∞1" required>
                            </div>
                            <div class="mb-4">
                                <label for="equip-type" class="block text-gray-700 font-medium mb-1">Type d'appareil</label>
                                <select id="equip-type" class="form-field custom-select" required>
                                    <!-- Options remplies par JS -->
                                </select>
                            </div>
                             <div class="mb-4">
                                <label for="equip-form-select" class="block text-gray-700 font-medium mb-1">Formulaire √† lier</label>
                                <select id="equip-form-select" class="form-field custom-select" required>
                                    <option value="">S√©lectionnez un formulaire</option>
                                    <!-- Options remplies par JS -->
                                </select>
                            </div>
                            <button type="submit" class="w-full btn btn-secondary">
                                Ajouter l'Appareil
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Colonne 2: Liste des Magasins et Appareils -->
                <div class="lg:col-span-2 card p-6 space-y-4">
                    <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-4">
                        <h2 class="text-xl font-bold text-primary-dark">Vos Magasins et Appareils</h2>
                        <div class="w-full sm:w-72">
                            <label for="store-search-input" class="block text-sm font-medium text-gray-600">Rechercher un magasin</label>
                            <input id="store-search-input" type="search" placeholder="Nom ou code du magasin" class="form-field mt-1" />
                        </div>
                    </div>

                    <!-- NOUVELLE BARRE D'ACTIONS DE MASSE -->
                    <div id="bulk-action-bar" class="hidden bg-blue-50 border border-blue-200 p-3 rounded-lg mb-4 flex flex-wrap gap-2 items-center justify-between">
                        <div>
                            <span id="bulk-action-count" class="font-bold">0</span>
                            <span class="font-medium"> appareil(s) s√©lectionn√©(s)</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="bulk-print-btn" class="btn btn-primary text-sm py-1 px-3">Imprimer QR</button>
                            <button id="bulk-duplicate-btn" class="btn btn-secondary text-sm py-1 px-3">Dupliquer</button>
                            <button id="bulk-delete-btn" class="btn btn-danger text-sm py-1 px-3">Supprimer</button>
                            <button id="bulk-deselect-btn" class="text-gray-600 hover:underline text-sm ml-2">Annuler</button>
                        </div>
                    </div>
                    
                    <div id="stores-list" class="space-y-6">
                        <!-- Contenu g√©n√©r√© par JS -->
                        <p class="text-gray-500">Aucun magasin enregistr√© pour le moment.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= PAGE 4: GESTION DES FORMULAIRES ================= -->
        <div id="page-forms" class="page hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Colonne 1: Cr√©ateur de formulaire -->
                <div class="lg:col-span-1 card p-6 h-fit">
                    <h2 class="text-xl font-bold mb-4 text-primary-dark">Cr√©er/Modifier un Formulaire</h2>
                    <form id="create-form-builder">
                        <input type="hidden" id="form-builder-id">
                        <div class="mb-4">
                            <label for="form-builder-title" class="block text-gray-700 font-medium mb-1">Titre du Formulaire</label>
                            <input type="text" id="form-builder-title" class="form-field" required>
                        </div>
                        
                        <h3 class="font-semibold mb-2 text-primary-dark">Champs du formulaire</h3>
                        <div id="form-builder-fields" class="space-y-4 mb-4">
                            <!-- Champs dynamiques ajout√©s ici -->
                        </div>

                        <button type="button" id="add-form-field-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 mb-4 font-medium">
                            + Ajouter un champ
                        </button>
                        <button type="submit" class="w-full btn btn-primary">
                            Enregistrer le Formulaire
                        </button>
                        <button type="button" id="cancel-edit-form-btn" class="w-full btn btn-gray mt-2 hidden">
                            Annuler l'√©dition
                        </button>
                    </form>
                </div>

                <!-- Colonne 2: Liste des formulaires existants -->
                <div class="lg:col-span-2 card p-6 space-y-4">
                    <h2 class="text-xl font-bold mb-4 text-primary-dark">Formulaires Existants</h2>
                    <div id="forms-list" class="space-y-4">
                        <!-- Contenu g√©n√©r√© par JS -->
                        <p class="text-gray-500">Aucun formulaire cr√©√© pour le moment.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= PAGE 5: RAPPORTS (Stats) ================= -->
        <div id="page-reports" class="page hidden">
            <div class="card p-6 space-y-4">
                <h2 class="text-2xl font-bold mb-6 text-primary-dark">Rapports d'Intervention</h2>

                <!-- Filtres -->
                <div class="grid gap-4 sm:grid-cols-2 mb-6">
                    <div>
                        <label for="report-filter-store" class="block text-gray-700 font-medium mb-1">Filtrer par Magasin</label>
                        <select id="report-filter-store" class="form-field custom-select">
                            <option value="all">Tous les magasins</option>
                            <!-- Options remplies par JS -->
                        </select>
                    </div>
                    <div>
                        <label for="report-search-input" class="block text-gray-700 font-medium mb-1">Rechercher un magasin</label>
                        <input id="report-search-input" type="search" placeholder="Nom ou code du magasin" class="form-field" />
                    </div>
                </div>

                <!-- Liste des rapports -->
                <div id="reports-list" class="space-y-4">
                    <!-- Contenu g√©n√©r√© par JS -->
                    <p class="text-gray-500 py-4">Aucun rapport soumis pour le moment.</p>
                </div>
            </div>
        </div>
        
        <!-- ================= PAGE 6: ADMIN ================= -->
        <div id="page-admin" class="page hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Colonne 1: Gestion des Utilisateurs -->
                <div class="space-y-6">
                    <div class="card p-6 h-fit space-y-4">
                        <h2 class="text-xl font-bold mb-4 text-primary-dark">Cr√©er un utilisateur</h2>
                        <form id="create-user-form" class="space-y-4">
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label for="create-user-first-name" class="block text-sm font-medium text-gray-700">Pr√©nom</label>
                                    <input type="text" id="create-user-first-name" class="form-field" placeholder="ex: L√©a" required>
                                </div>
                                <div>
                                    <label for="create-user-last-name" class="block text-sm font-medium text-gray-700">Nom</label>
                                    <input type="text" id="create-user-last-name" class="form-field" placeholder="ex: Martin" required>
                                </div>
                            </div>
                            <div>
                                <label for="create-user-email" class="block text-sm font-medium text-gray-700">Email professionnel</label>
                                <input type="email" id="create-user-email" class="form-field" placeholder="nom@entreprise.fr" required>
                            </div>
                            <div>
                                <label for="create-user-password" class="block text-sm font-medium text-gray-700">Mot de passe provisoire</label>
                                <input type="password" id="create-user-password" class="form-field" minlength="6" required>
                                <p class="text-xs text-gray-500 mt-1">L'utilisateur devra le remplacer lors de sa premi√®re connexion.</p>
                            </div>
                            <div>
                                <label for="create-user-role" class="block text-sm font-medium text-gray-700">R√¥le initial</label>
                                <select id="create-user-role" class="form-field custom-select">
                                    <option value="user" selected>Utilisateur</option>
                                    <option value="admin">Administrateur</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full btn btn-primary">Cr√©er et envoyer les acc√®s</button>
                        </form>
                    </div>
                    <div class="card p-6 h-fit space-y-4">
                        <h2 class="text-xl font-bold mb-4 text-primary-dark">Utilisateurs enregistr√©s</h2>
                        <div id="users-list" class="space-y-3">
                            <!-- Liste des utilisateurs charg√©e par JS -->
                        </div>
                    </div>
                </div>

                <!-- Colonne 2: Gestion des Types d'Appareils -->
                <div class="card p-6 h-fit space-y-4">
                    <h2 class="text-xl font-bold mb-4 text-primary-dark">Gestion des Types d'Appareils</h2>
                    
                    <!-- Onglets Ajout -->
                    <div class="flex border-b border-gray-200 mb-4">
                         <button id="tab-model-btn" class="tab-btn-admin flex-1 py-2 font-medium text-sm text-center border-b-2 border-secondary text-secondary">Ajout rapide (Mod√®les)</button>
                         <button id="tab-manual-btn" class="tab-btn-admin flex-1 py-2 font-medium text-sm text-center border-b-2 border-transparent text-gray-500">Ajout manuel</button>
                    </div>
                    
                    <!-- Panneau Ajout Mod√®les -->
                    <div id="tab-panel-model">
                        <form id="add-equip-type-model-form" class="space-y-3">
                             <div>
                                <label for="equip-type-model-select" class="block text-gray-700 font-medium mb-1">Choisir un mod√®le</label>
                                <select id="equip-type-model-select" class="form-field custom-select">
                                    <option value="">S√©lectionnez un mod√®le...</option>
                                </select>
                             </div>
                             <button type="submit" class="w-full btn btn-primary">Ajouter ce mod√®le</button>
                        </form>
                    </div>
                    
                    <!-- Panneau Ajout Manuel -->
                    <div id="tab-panel-manual" class="hidden">
                        <form id="add-equip-type-form" class="space-y-3">
                            <div>
                                <label for="equip-type-label" class="block text-gray-700 font-medium mb-1">Nom du type</label>
                                <input type="text" id="equip-type-label" placeholder="ex: Hotte" class="form-field" required>
                            </div>
                             <div>
                                <label for="equip-type-emoji" class="block text-gray-700 font-medium mb-1">Emoji</label>
                                <input type="text" id="equip-type-emoji" placeholder="ex: üå¨Ô∏è" class="form-field" required>
                            </div>
                            <button type="submit" class="w-full btn btn-primary">Ajouter manuellement</button>
                        </form>
                    </div>
                    
                    <hr class="my-6">
                    
                    <!-- Liste des types -->
                    <h3 class="text-lg font-semibold mb-3 text-primary-dark">Types existants</h3>
                    <div id="equip-types-list" class="space-y-2">
                        <!-- Liste des types charg√©e par JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ================= MODALS ================= -->

    <!-- Modal pour afficher le QR Code -->
    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-4xl w-full max-h-[90vh] flex flex-col">
            <h2 id="qr-modal-title" class="text-xl font-bold mb-4 text-primary-dark">QR Code de l'Appareil</h2>
            <p id="qr-modal-subtitle" class="text-gray-600 mb-4"></p>
            
            <!-- S√©lecteur de taille (pour simple) -->
            <div id="qr-size-select-wrapper" class="mb-4 no-print">
                <label for="qr-size-select" class="text-sm text-gray-600 mr-2">Taille:</label>
                <select id="qr-size-select" class="text-sm px-2 py-1 border border-gray-300 rounded-lg bg-white custom-select">
                    <option value="128">Petit</option>
                    <option value="256" selected>Moyen</option>
                    <option value="512">Grand</option>
                </select>
            </div>
            
            <!-- Le QR code (ou la grille) sera g√©n√©r√© ici -->
            <div id="qr-modal-content" class="flex-grow overflow-y-auto p-2">
                <!-- Contenu g√©n√©r√© par JS -->
            </div>
            
            <div class="flex space-x-2 no-print mt-4">
                <button id="print-qr-btn" class="w-full btn btn-primary">
                    Imprimer
                </button>
                <button id="close-qr-modal" class="w-full btn btn-gray">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal d'√©dition de Magasin -->
    <div id="edit-store-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h2 class="text-xl font-bold mb-4 text-primary-dark">Modifier le Magasin</h2>
            <form id="edit-store-form">
                <input type="hidden" id="edit-store-id">
                <div class="mb-4">
                    <label for="edit-store-name" class="block text-gray-700 font-medium mb-1">Nom du Magasin</label>
                    <input type="text" id="edit-store-name" class="form-field" required>
                </div>
                <div class="mb-4">
                    <label for="edit-store-code" class="block text-gray-700 font-medium mb-1">Code Magasin</label>
                    <input type="text" id="edit-store-code" class="form-field" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="modal-close-btn btn btn-gray">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal d'√©dition d'Appareil -->
    <div id="edit-equip-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h2 class="text-xl font-bold mb-4 text-primary-dark">Modifier l'Appareil</h2>
            <form id="edit-equip-form">
                <input type="hidden" id="edit-equip-id">
                <div class="mb-4">
                    <label for="edit-equip-name" class="block text-gray-700 font-medium mb-1">Nom de l'appareil</label>
                    <input type="text" id="edit-equip-name" class="form-field" required>
                </div>
                 <div class="mb-4">
                    <label for="edit-equip-form-select" class="block text-gray-700 font-medium mb-1">Formulaire √† lier</label>
                    <select id="edit-equip-form-select" class="form-field custom-select" required>
                        <option value="">S√©lectionnez un formulaire</option>
                        <!-- Options remplies par JS -->
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="modal-close-btn btn btn-gray">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODALE: √âdition Type d'Appareil -->
    <div id="edit-equip-type-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h2 class="text-xl font-bold mb-4 text-primary-dark">Modifier le Type d'Appareil</h2>
            <form id="edit-equip-type-form">
                <input type="hidden" id="edit-equip-type-id">
                <div class="mb-4">
                    <label for="edit-equip-type-label" class="block text-gray-700 font-medium mb-1">Nom du type</label>
                    <input type="text" id="edit-equip-type-label" class="form-field" required>
                </div>
                 <div class="mb-4">
                    <label for="edit-equip-type-emoji" class="block text-gray-700 font-medium mb-1">Emoji</label>
                    <input type="text" id="edit-equip-type-emoji" class="form-field" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="modal-close-btn btn btn-gray">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmation (G√©n√©rique) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h2 id="confirm-title" class="text-xl font-bold mb-4 text-primary-dark">√ätes-vous s√ªr ?</h2>
            <p id="confirm-text" class="text-gray-600 mb-6">Cette action est irr√©versible.</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-cancel-btn" class="btn btn-gray">
                    Annuler
                </button>
                <button id="confirm-action-btn" class="btn btn-danger">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal pour les messages (erreurs, succ√®s) -->
    <div id="message-modal" class="fixed top-5 right-5 bg-red-600 text-white p-4 rounded-lg shadow-xl z-50 hidden transition-opacity duration-300" role="alert">
        <div class="flex items-center gap-3">
            <p id="message-text" class="flex-1"></p>
            <button id="message-action-btn" class="hidden text-sm font-semibold underline decoration-2 decoration-white/70 focus:outline-none">Annuler</button>
        </div>
    </div>

    <!-- NOUVELLE MODALE: Duplication d'Appareils -->
    <div id="duplicate-equip-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h2 class="text-xl font-bold mb-4 text-primary-dark">Dupliquer les Appareils</h2>
            <p class="text-gray-600 mb-4">S√©lectionnez les magasins de destination o√π vous souhaitez copier les <span id="duplicate-count" class="font-bold">0</span> appareil(s) s√©lectionn√©(s).</p>
            <form id="duplicate-equip-form">
                <div id="duplicate-store-list" class="space-y-2 max-h-60 overflow-y-auto border p-3 rounded-lg mb-4">
                    <!-- Liste des magasins (checkboxes) g√©n√©r√©e par JS -->
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="modal-close-btn btn btn-gray">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-secondary">
                        Dupliquer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal d'√©dition de Rapport -->
    <div id="edit-report-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full">
            <h2 class="text-xl font-bold mb-4 text-primary-dark">Modifier le rapport</h2>
            <form id="edit-report-form" class="space-y-4">
                <input type="hidden" id="edit-report-id">
                <div id="edit-report-fields" class="space-y-3 max-h-72 overflow-y-auto pr-1">
                    <!-- Champs g√©n√©r√©s dynamiquement -->
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="modal-close-btn btn btn-gray">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ================= SCRIPT ================= -->
    <script type="module">
        // Importation des modules Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth,
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            deleteUser,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot,
            getDocs,
            deleteDoc,
            setLogLevel,
            updateDoc,
            writeBatch,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // SDK pour le stockage de fichiers (photos, etc.) - Futur
        /*
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        */

        // --- Configuration Firebase ---
        // REMPLACEZ PAR VOTRE PROPRE CONFIGURATION FIREBASE
        const firebaseConfig = {
        ¬† apiKey: "AIzaSyCJ3aNGOtir7Tank7Lxm5NEjUvHpsowOtE",
        ¬† authDomain: "pour-mich.firebaseapp.com",
        ¬† projectId: "pour-mich",
        ¬† storageBucket: "pour-mich.firebasestorage.app",
        ¬† messagingSenderId: "304617036411",
        ¬† appId: "1:304617036411:web:7cd6b421e3bd32f78d60de",
        ¬† measurementId: "G-5PBQJN1DVR"
        };
        // --- FIN DE LA CONFIGURATION ---

        const appId = 'gest-appareils-public'; // Nom de la collection principale

        // --- Variables Globales ---
        let app, auth, db, storage;
        let secondaryApp = null;
        let secondaryAuth = null;
        let currentUserId = null;
        let currentUserRole = null; // 'admin', 'user', ou 'new'
        let currentUserProfile = null;
        let isAuthReady = false;

        // Collections Firestore
        let usersCollection, storesCollection, equipmentCollection, formsCollection, reportsCollection, equipmentTypesCollection;

        // Etat de l'application (Cache local)
        let html5QrCode;
        let currentScannedData = null;
        let allStores = [];
        let allEquipment = [];
        let allForms = [];
        let allReports = [];
        let allEquipmentTypes = [];
        let equipmentListenerReady = false; // Flag pour g√©rer le chargement
        let selectedEquipmentIds = new Set(); // NOUVEAU: Pour la s√©lection multiple
        let storeSearchTerm = '';
        let openStoreIds = new Set();
        let reportSearchTerm = '';
        let openReportStoreIds = new Set();
        let currentBulkQrData = [];
        let messageTimeoutId = null;
        let messageActionHandler = null;
        
        // Listeners (pour les arr√™ter)
        let unsubForms = () => {}, unsubStores = () => {}, unsubEquipment = () => {}, unsubReports = () => {}, unsubUsers = () => {}, unsubEquipmentTypes = () => {};
        
        // Callback pour la modal de confirmation
        let _confirmCallback = null; 

        // Mod√®les de types d'appareils
        const equipmentTypeModels = {
            "Chauffage": "üî•", "Climatisation": "‚ùÑÔ∏è", "Ventilation": "üå¨Ô∏è", "√âlectricit√©": "‚ö°",
            "Plomberie": "üíß", "S√©curit√©": "üõ°Ô∏è", "Incendie": " extinguisher", "Ascenseur": "‚ÜïÔ∏è",
            "Porte Auto": "üö™", "Froid": "üßä", "Cuisine": "üç≥", "Lumi√®re": "üí°",
            "Extincteur": "üßØ", "Cam√©ra": "üì∑", "Alarme": "üö®"
        };
        
        // Fonction utilitaire pour r√©cup√©rer un √©l√©ment (√©vite les r√©p√©titions)
        function getEl(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`√âl√©ment introuvable: #${id}.`);
            }
            return el;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getDisplayName(profile) {
            if (!profile) return '';
            return [profile.firstName, profile.lastName]
                .filter(part => part && part.trim().length > 0)
                .join(' ')
                .trim();
        }

        function getSecondaryAuthInstance() {
            if (!secondaryApp) {
                secondaryApp = initializeApp(firebaseConfig, 'secondary');
            }
            if (!secondaryAuth) {
                secondaryAuth = getAuth(secondaryApp);
            }
            return secondaryAuth;
        }

        // --- Initialisation ---

        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (!secondaryApp) {
                    secondaryApp = initializeApp(firebaseConfig, 'secondary');
                    secondaryAuth = getAuth(secondaryApp);
                }
                // storage = getStorage(app); // Futur
                setLogLevel('Debug'); // Pour voir les logs Firestore

                // D√©finition des chemins de collection "publics"
                const basePath = `artifacts/${appId}/public/data`;
                usersCollection = collection(db, `${basePath}/users`);
                storesCollection = collection(db, `${basePath}/stores`);
                equipmentCollection = collection(db, `${basePath}/equipment`);
                formsCollection = collection(db, `${basePath}/forms`);
                reportsCollection = collection(db, `${basePath}/reports`);
                equipmentTypesCollection = collection(db, `${basePath}/equipmentTypes`);

                setupAuthListener();
                initializeAppEventListeners(); // REFACTOR: Appel de la fonction principale des √©couteurs
                populateModelSelect();
                
            } catch (error) {
                console.error("Erreur d'initialisation Firebase:", error);
                showMessage("Erreur critique d'initialisation.", "error");
            }
        }
        
        async function setupAuthListener() {
            const authButton = getEl('auth-button');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // L'utilisateur est connect√©
                    currentUserId = user.uid;
                    isAuthReady = true;
                    console.log("Utilisateur connect√©:", currentUserId);
                    
                    // R√©cup√©rer le r√¥le de l'utilisateur depuis Firestore
                    const userDocRef = doc(usersCollection, user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        currentUserProfile = { id: user.uid, ...userData };
                        currentUserRole = userData.role || 'user';

                        if (userData.mustChangePassword) {
                            showForcePasswordPage(userData, user.email);
                            return;
                        }

                        // G√©rer les r√¥les
                        if (currentUserRole === 'new') {
                            // R√¥le "new" -> Bloquer sur la page d'attente
                            initializeAppUI('new', user.email);
                        } else {
                            // R√¥le "user" ou "admin"
                            initializeAppUI(currentUserRole, user.email);
                        }

                    } else {
                        // Cas √©trange, l'utilisateur est authentifi√© mais n'a pas de document
                        console.error("Erreur: Document utilisateur introuvable pour l'UID:", user.uid);
                        showMessage("Erreur de profil, reconnexion...", "error");
                        await signOut(auth);
                    }

                } else {
                    // L'utilisateur est d√©connect√©
                    currentUserId = null;
                    currentUserRole = null;
                    currentUserProfile = null;
                    isAuthReady = false;
                    console.log("Utilisateur d√©connect√©.");

                    // Afficher la page de connexion, cacher le reste
                    getEl('main-header').classList.add('hidden');
                    getEl('main-nav').classList.add('hidden');
                    hideAllPages();
                    getEl('page-login').classList.remove('hidden');

                    const nameDisplay = getEl('user-name-display');
                    if (nameDisplay) nameDisplay.classList.add('hidden');
                    const emailDisplay = getEl('user-email-display');
                    if (emailDisplay) emailDisplay.classList.add('hidden');
                    const roleDisplay = getEl('user-role-display');
                    if (roleDisplay) roleDisplay.classList.add('hidden');

                    stopDataListeners(); // Arr√™ter les √©couteurs de donn√©es
                }
            });

            if (authButton) authButton.addEventListener('click', () => {
                if (auth.currentUser) {
                    signOut(auth);
                }
            });
        }
        
        // Affiche l'UI en fonction du r√¥le
        function showForcePasswordPage(userData, email) {
            hideAllPages();
            getEl('main-header').classList.add('hidden');
            getEl('main-nav').classList.add('hidden');

            const emailLabel = getEl('force-reset-email');
            if (emailLabel) emailLabel.textContent = email || '';

            const firstNameInput = getEl('force-first-name');
            if (firstNameInput) firstNameInput.value = userData.firstName || '';

            const lastNameInput = getEl('force-last-name');
            if (lastNameInput) lastNameInput.value = userData.lastName || '';

            const passwordInput = getEl('force-password');
            if (passwordInput) passwordInput.value = '';

            const confirmInput = getEl('force-password-confirm');
            if (confirmInput) confirmInput.value = '';

            getEl('page-password-reset').classList.remove('hidden');
        }

        function initializeAppUI(role, email) {
            console.log(`Initialisation de l'UI pour: ${email} (R√¥le: ${role})`);
            
            // Cacher la page de connexion
            hideAllPages();
            
            // Si le r√¥le est "new", afficher la page d'attente et cacher le header/nav
            if (role === 'new') {
                getEl('page-pending-approval').classList.remove('hidden');
                getEl('main-header').classList.add('hidden');
                getEl('main-nav').classList.add('hidden');
                return; // Arr√™ter l'initialisation ici
            }
            
            // Pour "user" et "admin", afficher l'application
            getEl('main-header').classList.remove('hidden');
            getEl('main-nav').classList.remove('hidden');

            // Afficher infos utilisateur
            const emailDisplay = getEl('user-email-display');
            if (emailDisplay) {
                emailDisplay.textContent = email;
                emailDisplay.classList.remove('hidden');
            }

            const nameDisplay = getEl('user-name-display');
            if (nameDisplay) {
                const displayName = getDisplayName(currentUserProfile);
                if (displayName) {
                    nameDisplay.textContent = displayName;
                    nameDisplay.classList.remove('hidden');
                } else {
                    nameDisplay.classList.add('hidden');
                }
            }

            const roleDisplay = getEl('user-role-display');
            if (roleDisplay) {
                const roleLabel = role === 'admin' ? 'ADMINISTRATEUR' : (role === 'user' ? 'UTILISATEUR' : 'EN ATTENTE');
                roleDisplay.textContent = roleLabel;
                roleDisplay.classList.remove('hidden');
            }

            // G√©rer la visibilit√© des onglets et des pages
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            if (role === 'admin') {
                adminOnlyElements.forEach(el => el.classList.remove('hidden'));
            } else {
                adminOnlyElements.forEach(el => el.classList.add('hidden'));
            }

            // D√©marrer les √©couteurs de donn√©es
            loadAllData(role);
            
            // Naviguer vers la page par d√©faut
            navigateTo('scanner'); 
        }
        
        // --- Chargement des donn√©es (Real-time) ---
        
        function stopDataListeners() {
            console.log("Arr√™t des listeners...");
            unsubForms();
            unsubStores();
            unsubEquipment();
            unsubReports();
            unsubUsers();
            unsubEquipmentTypes();
        }

        function loadAllData(role) {
            if (!isAuthReady) {
                 console.warn("L'authentification n'est pas pr√™te, chargement annul√©.");
                 return;
            }
            
            console.log("D√©marrage des listeners de donn√©es...");
            stopDataListeners(); // S'assurer que les anciens sont arr√™t√©s

            // 1. Charger les formulaires
            unsubForms = onSnapshot(formsCollection, (snapshot) => {
                allForms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (role === 'admin') renderFormsList();
                updateAllSelects();
                console.log("Formulaires charg√©s:", allForms.length);
            }, (error) => console.error("Erreur chargement formulaires:", error));
            
            // 2. Charger les types d'appareils
             unsubEquipmentTypes = onSnapshot(equipmentTypesCollection, (snapshot) => {
                allEquipmentTypes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (role === 'admin') renderEquipmentTypesList();
                populateEquipmentTypeSelects();
                console.log("Types d'appareils charg√©s:", allEquipmentTypes.length);
            }, (error) => console.error("Erreur chargement types appareils:", error));

            // 3. Charger les magasins
            unsubStores = onSnapshot(storesCollection, (snapshot) => {
                allStores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllSelects();
                renderReportsList(); // Mettre √† jour les noms de magasins dans les rapports
                console.log("Magasins charg√©s:", allStores.length);
                if (equipmentListenerReady && role === 'admin') renderStoresList();
            }, (error) => console.error("Erreur chargement magasins:", error));
            
            // 4. Charger les √©quipements
            unsubEquipment = onSnapshot(equipmentCollection, (snapshot) => {
                allEquipment = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                equipmentListenerReady = true;
                console.log("√âquipements charg√©s:", allEquipment.length);
                if (role === 'admin') renderStoresList(); 
            }, (error) => console.error("Erreur chargement √©quipements:", error));

            // 5. Charger les rapports (Stats)
            unsubReports = onSnapshot(query(reportsCollection), (snapshot) => {
                allReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Trier par date (plus r√©cent en premier)
                allReports.sort((a, b) => {
                    const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(0);
                    return dateB - dateA;
                });
                console.log("Rapports charg√©s:", allReports.length);
                renderReportsList();
            }, (error) => console.error("Erreur chargement rapports:", error));
            
            // 6. Charger les utilisateurs (Admin seulement)
            if (role === 'admin') {
                unsubUsers = onSnapshot(usersCollection, (snapshot) => {
                    const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsersList(users);
                    console.log("Utilisateurs charg√©s:", users.length);
                }, (error) => console.error("Erreur chargement utilisateurs:", error));
            }
        }

        // --- Remplissage des Selects (Menus d√©roulants) ---
        
        function updateAllSelects() {
            const storeSelects = [
                getEl('equip-store-select'),
                getEl('report-filter-store')
            ];
            
            const formSelects = [
                getEl('equip-form-select'),
                getEl('edit-equip-form-select')
            ];

            storeSelects.forEach(sel => {
                if(sel) {
                    const firstOptionValue = sel.options[0] ? sel.options[0].value : "all";
                    const firstOptionText = sel.options[0] ? sel.options[0].text : "Tous les magasins";
                    
                    sel.innerHTML = `<option value="${firstOptionValue}">${firstOptionText}</option>`; // Garder la premi√®re option
                    
                    allStores.sort((a,b) => a.name.localeCompare(b.name)).forEach(store => {
                        sel.innerHTML += `<option value="${store.id}">${store.name} (${store.code})</option>`;
                    });
                }
            });
            
            formSelects.forEach(sel => {
                 if(sel) {
                    const firstOption = sel.options[0] ? sel.options[0].outerHTML : '<option value="">S√©lectionnez</option>';
                    sel.innerHTML = firstOption;
                    allForms.sort((a,b) => a.title.localeCompare(b.title)).forEach(form => {
                        sel.innerHTML += `<option value="${form.id}">${form.title}</option>`;
                    });
                 }
            });
        }
        
        // Remplit les listes d√©roulantes des types d'appareils
        function populateEquipmentTypeSelects() {
            const selects = [
                getEl('equip-type'),
                getEl('edit-equip-type') // Note: Cet ID n'est pas dans le HTML, mais on le garde au cas o√π
            ];
            
            let optionsHtml = '<option value="">S√©lectionnez un type</option>'; // Ajout d'une option par d√©faut
            allEquipmentTypes.sort((a,b) => a.label.localeCompare(b.label)).forEach(type => {
                optionsHtml += `<option value="${type.id}">${type.emoji} ${type.label}</option>`;
            });
            
            selects.forEach(sel => {
                if(sel) sel.innerHTML = optionsHtml;
            });
        }
        
        // Remplit la liste des mod√®les de type d'appareil
        function populateModelSelect() {
            const select = getEl('equip-type-model-select');
            if (!select) return;
            
            const sortedModels = Object.entries(equipmentTypeModels)
                                     .sort((a, b) => a[0].localeCompare(b[0]));
            
            for (const [label, emoji] of sortedModels) {
                select.innerHTML += `<option value="${label},${emoji}">${emoji} ${label}</option>`;
            }
        }


        // --- Rendu HTML ---

        // Rendu de la liste des magasins et de leurs appareils
        function renderStoresList() {
            const listContainer = getEl('stores-list');
            if (!listContainer) return;

            const searchInput = getEl('store-search-input');
            if (searchInput && searchInput.value !== storeSearchTerm) {
                searchInput.value = storeSearchTerm;
            }

            if (allStores.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">Aucun magasin enregistr√© pour le moment.</p>';
                return;
            }

            const normalizedTerm = storeSearchTerm.trim().toLowerCase();
            openStoreIds = new Set([...openStoreIds].filter(id => allStores.some(store => store.id === id)));

            const filteredStores = allStores
                .filter(store => {
                    if (!normalizedTerm) return true;
                    const name = (store.name || '').toLowerCase();
                    const code = (store.code || '').toLowerCase();
                    return name.includes(normalizedTerm) || code.includes(normalizedTerm);
                })
                .sort((a, b) => a.name.localeCompare(b.name));

            if (filteredStores.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">Aucun magasin ne correspond √† votre recherche.</p>';
                return;
            }

            listContainer.innerHTML = filteredStores.map(store => {
                const equipmentList = allEquipment
                    .filter(e => e.storeId === store.id)
                    .sort((a, b) => a.name.localeCompare(b.name));

                const hasSearch = normalizedTerm.length > 0;
                const isOpen = hasSearch || openStoreIds.has(store.id);
                const toggleIcon = isOpen ? '&minus;' : '+';
                const equipmentWrapperClasses = `p-4 space-y-3 bg-white ${isOpen ? '' : 'hidden'}`;
                const storeNameSafe = escapeHtml(store.name || 'Magasin');
                const storeCodeSafe = escapeHtml(store.code || '');

                const equipmentsHtml = equipmentList.length > 0
                    ? equipmentList.map(equip => {
                        const equipType = allEquipmentTypes.find(t => t.id === equip.type);
                        const emoji = equipType ? equipType.emoji : '‚öôÔ∏è';
                        const isChecked = selectedEquipmentIds.has(equip.id) ? 'checked' : '';
                        const equipNameSafe = escapeHtml(equip.name);
                        return `
                            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-md">
                                <div class="flex items-center">
                                    <input type="checkbox" class="equip-select-checkbox h-5 w-5 rounded mr-3" data-equip-id="${equip.id}" ${isChecked}>
                                    <div>
                                        <span class="text-2xl mr-2">${emoji}</span>
                                        <span class="font-medium">${equipNameSafe}</span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2 justify-end">
                                    <button class="edit-equip-btn text-xs bg-yellow-500 text-white px-2 py-1 rounded-lg hover:bg-yellow-600 font-medium" data-equip-id="${equip.id}">Modifier</button>
                                    <button class="delete-equip-btn text-xs btn-danger text-white px-2 py-1 rounded-lg hover:bg-red-600 font-medium" data-equip-id="${equip.id}">Suppr.</button>
                                    <button class="generate-qr-btn bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded-lg text-sm hover:bg-gray-50 font-medium"
                                            data-equip-id="${equip.id}"
                                            data-store-id="${store.id}"
                                            data-form-id="${equip.formId}"
                                            data-store-name="${escapeHtml(store.name || '')}"
                                            data-equip-name="${escapeHtml(equip.name || '')}">
                                        G√©n√©rer QR
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-sm text-gray-500">Aucun appareil ajout√© pour le moment.</p>';

                return `
                    <div class="border border-gray-200 rounded-lg overflow-hidden" data-store-id="${store.id}">
                        <div class="bg-gray-50 p-4 border-b border-gray-200">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                <button type="button" class="store-toggle flex-1 text-left" data-store-id="${store.id}">
                                    <div class="flex items-center justify-between gap-3">
                                        <div>
                                            <h3 class="text-lg font-bold text-primary">${storeNameSafe}</h3>
                                            <p class="text-sm text-gray-500">Code: ${storeCodeSafe || '‚Äî'}</p>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm text-gray-500">
                                            <span>${equipmentList.length} appareil(s)</span>
                                            <span class="text-xl font-bold text-secondary">${toggleIcon}</span>
                                        </div>
                                    </div>
                                </button>
                                <div class="flex space-x-2">
                                    <button class="edit-store-btn text-sm bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 font-medium" data-store-id="${store.id}">Modifier</button>
                                    <button class="delete-store-btn text-sm btn-danger text-white px-3 py-1 rounded-lg hover:bg-red-600 font-medium" data-store-id="${store.id}">Supprimer</button>
                                </div>
                            </div>
                        </div>
                        <div class="${equipmentWrapperClasses}" data-store-equipments="${store.id}">
                            <h4 class="font-semibold text-gray-700">Appareils :</h4>
                            ${equipmentsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Rendu de la liste des formulaires
        function renderFormsList() {
            const listContainer = getEl('forms-list');
             if (!listContainer) return;

            if (allForms.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">Aucun formulaire cr√©√© pour le moment.</p>';
                return;
            }
            listContainer.innerHTML = allForms
                .sort((a,b) => a.title.localeCompare(b.title)) // Trier par titre
                .map(form => `
                <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-primary">${form.title}</h3>
                            <ul class="list-disc list-inside mt-2 text-sm text-gray-600">
                                ${form.fields.map(f => `<li>${f.label} ${f.required ? '(Req.)' : ''} - [${f.type}]</li>`).join('')}
                            </ul>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:space-x-2 flex-shrink-0">
                             <button class="edit-form-btn text-yellow-600 hover:underline text-sm mt-1" data-form-id="${form.id}">
                                Modifier
                            </button>
                            <button class="delete-form-btn text-danger hover:underline text-sm mt-1" data-form-id="${form.id}">
                                Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Rendu de la liste des rapports (Stats)
        function renderReportsList() {
            const listContainer = getEl('reports-list');
            const filterSelect = getEl('report-filter-store');

            if (!listContainer || !filterSelect) return;

            const searchInput = getEl('report-search-input');
            if (searchInput && searchInput.value !== reportSearchTerm) {
                searchInput.value = reportSearchTerm;
            }

            const filterStoreId = filterSelect.value;
            const normalizedSearch = reportSearchTerm.trim().toLowerCase();

            const grouped = new Map();

            allReports.forEach(report => {
                if (filterStoreId !== 'all' && report.storeId !== filterStoreId) return;

                const store = allStores.find(s => s.id === report.storeId);
                const storeName = store ? store.name : `Magasin inconnu`;
                const storeCode = store ? (store.code || '') : '';
                const matchesSearch = !normalizedSearch ||
                    storeName.toLowerCase().includes(normalizedSearch) ||
                    storeCode.toLowerCase().includes(normalizedSearch);

                if (!matchesSearch) return;

                if (!grouped.has(report.storeId)) {
                    grouped.set(report.storeId, { store, reports: [] });
                }
                grouped.get(report.storeId).reports.push(report);
            });

            if (grouped.size === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 py-4">Aucun rapport ne correspond √† votre recherche.</p>';
                return;
            }

            openReportStoreIds = new Set([...openReportStoreIds].filter(id => grouped.has(id)));

            const groupedArray = Array.from(grouped.entries()).map(([storeId, data]) => ({
                storeId,
                store: data.store,
                reports: data.reports.sort((a, b) => {
                    const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(0);
                    return dateB - dateA;
                })
            })).sort((a, b) => {
                const nameA = a.store ? a.store.name : '';
                const nameB = b.store ? b.store.name : '';
                return nameA.localeCompare(nameB);
            });

            listContainer.innerHTML = groupedArray.map(group => {
                const storeName = group.store ? group.store.name : `Magasin inconnu`;
                const storeCode = group.store && group.store.code ? group.store.code : '';
                const storeNameSafe = escapeHtml(storeName);
                const storeCodeSafe = escapeHtml(storeCode);
                const hasSearch = normalizedSearch.length > 0;
                const isOpen = hasSearch || openReportStoreIds.has(group.storeId);
                const toggleIcon = isOpen ? '&minus;' : '+';
                const wrapperClasses = `divide-y divide-gray-200 ${isOpen ? '' : 'hidden'}`;

                const reportsHtml = group.reports.map(report => {
                    const reportDate = report.timestamp?.toDate ? report.timestamp.toDate().toLocaleString('fr-FR') : 'Date inconnue';
                    const submitter = report.userEmail || report.userId || 'Utilisateur inconnu';
                    const reportDateSafe = escapeHtml(reportDate);
                    const submitterSafe = escapeHtml(submitter);
                    const dataEntries = Object.entries(report.data || {});
                    const dataHtml = dataEntries.length > 0
                        ? dataEntries.map(([key, value]) => {
                            const keySafe = escapeHtml(key);
                            if (Array.isArray(value)) {
                                const listItems = value.map(v => `<li class="ml-4 list-disc">${escapeHtml(v)}</li>`).join('');
                                return `<li><strong>${keySafe}:</strong><ul>${listItems}</ul></li>`;
                            }
                            return `<li><strong>${keySafe}:</strong> <span class="font-medium">${escapeHtml(value)}</span></li>`;
                        }).join('')
                        : '<li>Aucune donn√©e</li>';

                    return `
                        <div class="p-4 bg-white" data-report-id="${report.id}">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <p class="font-semibold text-sm text-gray-700">${reportDateSafe}</p>
                                    <p class="text-xs text-gray-500">Soumis par <span class="font-mono">${submitterSafe}</span></p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="edit-report-btn text-xs bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 font-medium" data-report-id="${report.id}">√âditer</button>
                                    <button class="delete-report-btn text-xs btn-danger text-white px-3 py-1 rounded-lg hover:bg-red-600 font-medium" data-report-id="${report.id}">Supprimer</button>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-md mt-3 text-sm text-gray-700">
                                <h4 class="font-semibold mb-2">Donn√©es soumises</h4>
                                <ul class="list-disc list-inside space-y-1">${dataHtml}</ul>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="border border-gray-200 rounded-lg overflow-hidden" data-report-store-id="${group.storeId}">
                        <div class="bg-gray-50 p-4 border-b border-gray-200">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                <button type="button" class="report-store-toggle flex-1 text-left" data-store-id="${group.storeId}">
                                    <div class="flex items-center justify-between gap-3">
                                        <div>
                                            <h3 class="text-lg font-bold text-primary">${storeNameSafe}</h3>
                                            ${storeCode ? `<p class="text-sm text-gray-500">Code: ${storeCodeSafe}</p>` : ''}
                                        </div>
                                        <div class="flex items-center gap-2 text-sm text-gray-500">
                                            <span>${group.reports.length} rapport(s)</span>
                                            <span class="text-xl font-bold text-secondary">${toggleIcon}</span>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        <div class="${wrapperClasses}" data-report-store="${group.storeId}">
                            ${reportsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function handleReportsListClick(e) {
            const toggleBtn = e.target.closest('.report-store-toggle');
            if (toggleBtn) {
                const storeId = toggleBtn.dataset.storeId;
                if (openReportStoreIds.has(storeId)) {
                    openReportStoreIds.delete(storeId);
                } else {
                    openReportStoreIds.add(storeId);
                }
                renderReportsList();
                return;
            }

            const target = e.target;
            if (!isAuthReady) return;

            if (target.classList.contains('edit-report-btn')) {
                const reportId = target.dataset.reportId;
                openEditReportModal(reportId);
                return;
            }

            if (target.classList.contains('delete-report-btn')) {
                const reportId = target.dataset.reportId;

                showConfirmationModal(
                    'Supprimer ce rapport ?',
                    'Le rapport sera supprim√© d√©finitivement.',
                    async () => {
                        try {
                            const reportRef = doc(reportsCollection, reportId);
                            const snapshot = await getDoc(reportRef);
                            if (!snapshot.exists()) {
                                showMessage('Rapport introuvable.', 'error');
                                return;
                            }
                            const reportData = snapshot.data();

                            await deleteDoc(reportRef);

                            showMessage('Rapport supprim√©.', 'success', {
                                actionLabel: 'Annuler',
                                duration: 5000,
                                onAction: async () => {
                                    await setDoc(reportRef, reportData);
                                    showMessage('Suppression annul√©e.', 'success');
                                }
                            });
                        } catch (error) {
                            console.error('Erreur suppression rapport:', error);
                            showMessage('Erreur lors de la suppression.', 'error');
                        }
                    }
                );
            }
        }

        function openEditReportModal(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (!report) {
                showMessage('Rapport introuvable.', 'error');
                return;
            }

            const fieldsContainer = getEl('edit-report-fields');
            fieldsContainer.innerHTML = '';

            const entries = Object.entries(report.data || {});
            if (entries.length === 0) {
                fieldsContainer.innerHTML = '<p class="text-sm text-gray-500">Aucune donn√©e √† modifier.</p>';
            } else {
                entries.forEach(([key, value]) => {
                    const isArray = Array.isArray(value);
                    const currentValue = isArray ? value.join('\n') : String(value ?? '');
                    const rows = Math.max(2, currentValue.split('\n').length);
                    const keySafe = escapeHtml(key);
                    const safeValue = escapeHtml(currentValue);
                    fieldsContainer.insertAdjacentHTML('beforeend', `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${keySafe}</label>
                            <textarea class="form-field" data-key="${escapeHtml(key)}" data-type="${isArray ? 'array' : 'string'}" rows="${rows}">${safeValue}</textarea>
                        </div>
                    `);
                });
            }

            getEl('edit-report-id').value = report.id;
            getEl('edit-report-modal').classList.remove('hidden');
        }

        async function handleEditReportSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const reportId = getEl('edit-report-id').value;
            const reportRef = doc(reportsCollection, reportId);

            const fields = Array.from(document.querySelectorAll('#edit-report-fields textarea'));
            const updatedData = {};

            if (fields.length === 0) {
                closeModal(getEl('edit-report-modal'));
                showMessage('Aucune donn√©e √† mettre √† jour pour ce rapport.', 'success');
                return;
            }

            fields.forEach(field => {
                const key = field.dataset.key;
                const type = field.dataset.type;
                const value = field.value.trim();

                if (type === 'array') {
                    updatedData[key] = value ? value.split('\n').map(v => v.trim()).filter(v => v.length > 0) : [];
                } else {
                    updatedData[key] = value;
                }
            });

            try {
                await updateDoc(reportRef, { data: updatedData });
                closeModal(getEl('edit-report-modal'));
                showMessage('Rapport mis √† jour.', 'success');
            } catch (error) {
                console.error('Erreur mise √† jour rapport:', error);
                showMessage('Erreur lors de la mise √† jour du rapport.', 'error');
            }
        }
        
        // Rendu de la liste des utilisateurs (Admin)
        function renderUsersList(users) {
            const listContainer = getEl('users-list');
            if (!listContainer) return;

            const activeProfile = users.find(u => u.id === currentUserId);
            if (activeProfile) {
                currentUserProfile = { ...activeProfile };
                const nameDisplay = getEl('user-name-display');
                if (nameDisplay) {
                    const displayName = getDisplayName(currentUserProfile);
                    if (displayName) {
                        nameDisplay.textContent = escapeHtml(displayName);
                        nameDisplay.classList.remove('hidden');
                    } else {
                        nameDisplay.classList.add('hidden');
                    }
                }
            }

            listContainer.innerHTML = users
                .sort((a, b) => (a.email || '').localeCompare(b.email || ''))
                .map(user => {
                    const isCurrentUser = user.id === currentUserId;
                    const userIdAttr = escapeHtml(user.id || '');
                    const email = escapeHtml(user.email || '');
                    const firstNameValue = escapeHtml(user.firstName || '');
                    const lastNameValue = escapeHtml(user.lastName || '');
                    const fonctionValue = escapeHtml(user.fonction || '');
                    const rawDisplayName = [user.firstName, user.lastName].filter(Boolean).join(' ');
                    const displayName = rawDisplayName ? escapeHtml(rawDisplayName) : '';
                    const userRole = user.role || 'user';

                    const roleOptions = userRole === 'new'
                        ? `
                            <option value="new" ${userRole === 'new' ? 'selected' : ''}>Nouveau (En attente)</option>
                            <option value="user" ${userRole === 'user' ? 'selected' : ''}>Utilisateur</option>
                            <option value="admin" ${userRole === 'admin' ? 'selected' : ''}>Administrateur</option>
                        `
                        : `
                            <option value="user" ${userRole === 'user' ? 'selected' : ''}>Utilisateur</option>
                            <option value="admin" ${userRole === 'admin' ? 'selected' : ''}>Administrateur</option>
                        `;

                    const statusBadge = user.mustChangePassword
                        ? '<span class="badge bg-secondary text-white">MDP √† changer</span>'
                        : '<span class="badge bg-emerald-100 text-emerald-800">Actif</span>';

                    const resetButtonLabel = user.mustChangePassword
                        ? 'R√©initialisation en attente'
                        : 'Forcer la r√©initialisation';

                    const resetButtonDisabled = user.mustChangePassword ? 'disabled' : '';

                    const roleBadge = userRole === 'admin'
                        ? '<span class="badge bg-primary text-white">Admin</span>'
                        : (userRole === 'new'
                            ? '<span class="badge bg-amber-100 text-amber-800">En attente</span>'
                            : '<span class="badge bg-emerald-100 text-emerald-800">Utilisateur</span>');

                    const baseClasses = ['user-row', 'border', 'border-gray-200', 'rounded-xl', 'p-4', 'space-y-4', 'shadow-sm', 'bg-white'];
                    if (isCurrentUser) baseClasses.push('border-emerald-400', 'shadow-md');
                    if (userRole === 'new') baseClasses.push('bg-amber-50');
                    const rowClass = baseClasses.join(' ');

                    return `
                        <div class="${rowClass}" data-user-id="${userIdAttr}" data-user-email="${email}">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                <div>
                                    <p class="text-base font-semibold text-primary-dark">${displayName || 'Nom non renseign√©'}</p>
                                    <p class="text-sm text-gray-500">${email}</p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${statusBadge}
                                    ${roleBadge}
                                </div>
                            </div>
                            <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Pr√©nom</label>
                                    <input type="text" class="form-field text-sm py-2" data-key="firstName" value="${firstNameValue}" ${isCurrentUser ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Nom</label>
                                    <input type="text" class="form-field text-sm py-2" data-key="lastName" value="${lastNameValue}" ${isCurrentUser ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">Fonction</label>
                                    <input type="text" class="form-field text-sm py-2" data-key="fonction" value="${fonctionValue}" placeholder="ex: Technicien" ${isCurrentUser ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-500">R√¥le</label>
                                    <select class="form-field custom-select text-sm py-2" data-key="role" ${isCurrentUser ? 'disabled' : ''}>
                                        ${roleOptions}
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button class="save-user-btn btn btn-primary text-sm py-1" data-user-id="${userIdAttr}" ${isCurrentUser ? 'disabled' : ''}>
                                    Enregistrer
                                </button>
                                <button class="force-reset-btn btn btn-secondary text-sm py-1" data-user-id="${userIdAttr}" ${isCurrentUser ? 'disabled' : resetButtonDisabled}>
                                    ${resetButtonLabel}
                                </button>
                                <button class="delete-user-btn btn btn-danger text-sm py-1" data-user-id="${userIdAttr}" ${isCurrentUser ? 'disabled' : ''}>
                                    Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        // Rendu de la liste des types d'appareils (Admin)
        function renderEquipmentTypesList() {
            const listContainer = getEl('equip-types-list');
            if (!listContainer) return; 

            if (allEquipmentTypes.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500">Aucun type d\'appareil cr√©√©.</p>';
                return;
            }

            listContainer.innerHTML = allEquipmentTypes
                .sort((a, b) => a.label.localeCompare(b.label)) // Trier par nom
                .map(type => {
                return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                    <div>
                        <span class="text-xl mr-2">${type.emoji}</span>
                        <span class="font-medium text-sm">${type.label}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-equip-type-btn text-yellow-600 hover:underline text-xs" data-type-id="${type.id}">
                            Modifier
                        </button>
                        <button class="delete-equip-type-btn text-danger hover:underline text-xs" data-type-id="${type.id}">
                            Supprimer
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        // Rendu du formulaire d'intervention dynamique
        function renderInterventionForm(formId) {
            const form = allForms.find(f => f.id === formId);
            const container = getEl('dynamic-form-fields');
            
            if (!form) {
                container.innerHTML = `<p class="text-danger">Erreur: Formulaire (ID: ${formId}) introuvable.</p>`;
                return;
            }

            getEl('form-title').textContent = form.title;
            container.innerHTML = form.fields.map(field => {
                const isRequired = field.required ? 'required' : '';
                const fieldId = `form-field-${field.label.replace(/\s+/g, '-')}`;
                const options = (field.options || "").split(',').map(opt => opt.trim()).filter(opt => opt.length > 0);

                let inputHtml = '';
                const fieldWrapper = (content) => `
                    <div>
                        <label for="${fieldId}" class="block text-gray-700 font-medium mb-1">
                            ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        ${content}
                    </div>`;

                switch (field.type) {
                    case 'textarea':
                        inputHtml = fieldWrapper(`<textarea id="${fieldId}" name="${field.label}" class="form-field" rows="3" ${isRequired}></textarea>`);
                        break;
                    case 'number':
                        inputHtml = fieldWrapper(`<input type="number" id="${fieldId}" name="${field.label}" class="form-field" ${isRequired}>`);
                        break;
                    case 'select':
                        inputHtml = fieldWrapper(`
                            <select id="${fieldId}" name="${field.label}" class="form-field custom-select" ${isRequired}>
                                <option value="">-- S√©lectionnez une option --</option>
                                ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `);
                        break;
                    case 'radio':
                        inputHtml = fieldWrapper(`
                            <div class="mt-2 space-y-2">
                                ${options.map((opt, index) => `
                                    <label class="flex items-center">
                                        <input type="radio" id="${fieldId}-${index}" name="${field.label}" value="${opt}" class="mr-2" ${isRequired}>
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `);
                        break;
                    case 'checkbox':
                        // Pour les checkboxes, le name est un tableau
                        inputHtml = fieldWrapper(`
                            <div class="mt-2 space-y-2">
                                ${options.map((opt, index) => `
                                    <label class="flex items-center">
                                        <input type="checkbox" id="${fieldId}-${index}" name="${field.label}" value="${opt}" class="mr-2 rounded">
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `);
                        break;
                    case 'text':
                    default:
                        inputHtml = fieldWrapper(`<input type="text" id="${fieldId}" name="${field.label}" class="form-field" ${isRequired}>`);
                }
                
                return inputHtml;
            }).join('');
        }

        // --- REFACTOR: Configuration des √âcouteurs d'√âv√©nements ---

        // Fonction principale qui attache tous les √©couteurs statiques au d√©marrage.
        function initializeAppEventListeners() {
            // Authentification
            setupAuthEventListeners();
            
            // Navigation principale
            setupNavigationEventListeners();
            
            // Page Magasins (Formulaires et listes)
            setupStorePageEventListeners();
            
            // Page Formulaires (Form Builder)
            setupFormBuilderEventListeners();

            // Page Intervention
            setupInterventionEventListeners();
            
            // Page Scanner
            setupScannerEventListeners();
            
            // Page Admin
            setupAdminEventListeners();
            
            // Page Rapports
            setupReportEventListeners();
            
            // Modales
            setupModalEventListeners();
        }

        // Groupe: Authentification
        function setupAuthEventListeners() {
            getEl('show-signup').addEventListener('click', (e) => {
                e.preventDefault();
                getEl('login-form').classList.add('hidden');
                getEl('signup-form').classList.remove('hidden');
            });
            
            getEl('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                getEl('login-form').classList.remove('hidden');
                getEl('signup-form').classList.add('hidden');
            });

            getEl('signup-form').addEventListener('submit', handleSignup);
            getEl('login-form').addEventListener('submit', handleLogin);

            const forcePasswordForm = getEl('force-password-form');
            if (forcePasswordForm) {
                forcePasswordForm.addEventListener('submit', handleForcePasswordForm);
            }
        }

        // Groupe: Navigation
        function setupNavigationEventListeners() {
            getEl('main-nav').addEventListener('click', (e) => {
                if (e.target.classList.contains('nav-tab')) {
                    const pageId = e.target.dataset.page;
                    navigateTo(pageId);
                }
            });
        }
        
        // Groupe: Page Magasins
        function setupStorePageEventListeners() {
            // Formulaires d'ajout
            getEl('add-store-form').addEventListener('submit', handleAddStore);
            getEl('add-equipment-form').addEventListener('submit', handleAddEquipment);

            const storeSearchInput = getEl('store-search-input');
            if (storeSearchInput) {
                storeSearchInput.addEventListener('input', (e) => {
                    storeSearchTerm = e.target.value;
                    renderStoresList();
                });
            }

            // Clics sur la liste (d√©l√©gation d'√©v√©nements)
            getEl('stores-list').addEventListener('click', handleStoresListClick);
            // NOUVEAU: √âcouteur pour les checkboxes
            getEl('stores-list').addEventListener('change', handleEquipSelectChange);
            
            // Soumission des modales d'√©dition
            getEl('edit-store-form').addEventListener('submit', handleEditStore);
            getEl('edit-equip-form').addEventListener('submit', handleEditEquipment);
            
            // NOUVEAU: √âcouteurs pour la barre d'actions de masse
            getEl('bulk-print-btn').addEventListener('click', handleBulkPrintClick);
            getEl('bulk-duplicate-btn').addEventListener('click', handleBulkDuplicateClick);
            getEl('bulk-delete-btn').addEventListener('click', handleBulkDeleteClick);
            getEl('bulk-deselect-btn').addEventListener('click', handleDeselectAll);
            
            // NOUVEAU: Soumission de la modale de duplication
            getEl('duplicate-equip-form').addEventListener('submit', handleSubmitDuplicate);
        }
        
        // Groupe: Page Formulaires (Form Builder)
        function setupFormBuilderEventListeners() {
            getEl('create-form-builder').addEventListener('submit', handleSaveForm);
            getEl('cancel-edit-form-btn').addEventListener('click', resetFormBuilder);
            getEl('add-form-field-btn').addEventListener('click', () => {
                addFormFieldToBuilder(getEl('form-builder-fields'));
            });

            // D√©l√©gation pour les champs dynamiques du builder
            const fieldsContainer = getEl('form-builder-fields');
            fieldsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-field-btn')) handleRemoveField(e);
                if (e.target.classList.contains('add-option-btn')) handleAddOption(e);
                if (e.target.classList.contains('remove-option-btn')) handleRemoveOption(e);
            });
            fieldsContainer.addEventListener('change', handleFieldTypeChange);
            
            // D√©l√©gation pour la liste des formulaires existants
            getEl('forms-list').addEventListener('click', handleFormsListClick);
        }
        
        // Groupe: Page Intervention
        function setupInterventionEventListeners() {
            getEl('intervention-form').addEventListener('submit', handleSubmitIntervention);
            getEl('back-to-scanner').addEventListener('click', () => {
                navigateTo('scanner');
                currentScannedData = null; // R√©initialiser
            });
        }
        
        // Groupe: Page Scanner
        function setupScannerEventListeners() {
            getEl('start-scan-btn').addEventListener('click', startScan);
            getEl('stop-scan-btn').addEventListener('click', stopScan);
        }
        
        // Groupe: Page Admin
        function setupAdminEventListeners() {
            const createUserForm = getEl('create-user-form');
            if (createUserForm) {
                createUserForm.addEventListener('submit', handleCreateUser);
            }

            // D√©l√©gation pour la liste des utilisateurs
            getEl('users-list').addEventListener('click', handleUsersListClick);
            
            // Onglets pour type d'appareil
            getEl('tab-model-btn').addEventListener('click', showAdminTabModel);
            getEl('tab-manual-btn').addEventListener('click', showAdminTabManual);
            
            // Formulaires d'ajout de type
            getEl('add-equip-type-model-form').addEventListener('submit', handleAddEquipTypeModel);
            getEl('add-equip-type-form').addEventListener('submit', handleAddEquipTypeManual);

            // D√©l√©gation pour la liste des types
            getEl('equip-types-list').addEventListener('click', handleEquipTypesListClick);
            
            // Soumission modale √©dition type
            getEl('edit-equip-type-form').addEventListener('submit', handleEditEquipType);
        }
        
        // Groupe: Page Rapports
        function setupReportEventListeners() {
            const filterSelect = getEl('report-filter-store');
            if (filterSelect) {
                filterSelect.addEventListener('change', renderReportsList);
            }

            const searchInput = getEl('report-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    reportSearchTerm = e.target.value;
                    renderReportsList();
                });
            }

            const reportsList = getEl('reports-list');
            if (reportsList) {
                reportsList.addEventListener('click', handleReportsListClick);
            }

            const editReportForm = getEl('edit-report-form');
            if (editReportForm) {
                editReportForm.addEventListener('submit', handleEditReportSubmit);
            }
        }
        
        // Groupe: Modales
        function setupModalEventListeners() {
            // Boutons de fermeture g√©n√©riques
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.target.closest('.fixed'));
                });
            });

            // Modale QR Code
            getEl('qr-size-select').addEventListener('change', () => {
                 const modalContent = getEl('qr-modal-content');
                 const simpleRaw = modalContent.dataset.simpleData || '';
                 const simpleData = simpleRaw ? JSON.parse(simpleRaw) : null;
                 if (simpleData) {
                    generateSingleQrCode(simpleData.data, simpleData.equipName, simpleData.storeName);
                 } else if (currentBulkQrData && currentBulkQrData.length > 0) {
                    renderBulkQrCodes();
                 }
            });
            getEl('close-qr-modal').addEventListener('click', () => {
                 closeModal(getEl('qr-modal'));
            });
            getEl('print-qr-btn').addEventListener('click', () => window.print());

            const messageActionBtn = getEl('message-action-btn');
            if (messageActionBtn) {
                messageActionBtn.addEventListener('click', async () => {
                    if (typeof messageActionHandler === 'function') {
                        const handler = messageActionHandler;
                        messageActionHandler = null;
                        hideMessageModal();
                        try {
                            await handler();
                        } catch (error) {
                            console.error('Erreur lors de l\'action du message:', error);
                            showMessage('Impossible d\'annuler cette action.', 'error');
                        }
                    }
                });
            }

            // Modale de Confirmation
            getEl('confirm-action-btn').addEventListener('click', () => {
                if (typeof _confirmCallback === 'function') {
                    _confirmCallback();
                }
                _confirmCallback = null;
                closeModal(getEl('confirm-modal'));
            });
            getEl('confirm-cancel-btn').addEventListener('click', () => {
                _confirmCallback = null;
                closeModal(getEl('confirm-modal'));
            });
        }

        function closeModal(modalEl) {
            if (!modalEl) return;
            modalEl.classList.add('hidden');

            if (modalEl.id === 'qr-modal') {
                const content = getEl('qr-modal-content');
                if (content) content.dataset.simpleData = '';
                currentBulkQrData = [];
            }

            if (modalEl.id === 'edit-report-modal') {
                getEl('edit-report-fields').innerHTML = '';
                getEl('edit-report-id').value = '';
            }
        }

        // --- REFACTOR: Logique M√©tier (Handlers d'√©v√©nements) ---

        // Handler: Inscription
        async function handleSignup(e) {
            e.preventDefault();
            const email = getEl('signup-email').value;
            const password = getEl('signup-password').value;

            try {
                // 1. Cr√©er l'utilisateur dans Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("Utilisateur cr√©√© dans Auth:", user.uid);
                
                // 2. R√¥le "new" par d√©faut
                const newRole = 'new';
                console.log(`Attribution du r√¥le: ${newRole}`);
                
                // 3. Cr√©er le document utilisateur dans Firestore
                await setDoc(doc(usersCollection, user.uid), {
                    email: user.email,
                    role: newRole,
                    fonction: "",
                    firstName: "",
                    lastName: "",
                    displayName: "",
                    mustChangePassword: false,
                    status: 'pending',
                    createdAt: new Date(),
                    createdBy: user.uid
                });
                
                showMessage(`Compte cr√©√© avec succ√®s ! Il est en attente d'approbation.`, 'success');
                await signOut(auth); // D√©connecter l'utilisateur
                e.target.reset(); // Vider le formulaire
                getEl('show-login').click(); // Revenir au formulaire de connexion
                
            } catch (error) {
                console.error("Erreur d'inscription:", error);
                showMessage(`Erreur: ${error.message}`, "error");
            }
        }
        
        // Handler: Connexion
        async function handleLogin(e) {
            e.preventDefault();
            const email = getEl('login-email').value;
            const password = getEl('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged s'occupe du reste
            } catch (error) {
                console.error("Erreur de connexion:", error);
                showMessage("Email ou mot de passe incorrect.", "error");
            }
        }

        async function handleForcePasswordForm(e) {
            e.preventDefault();

            if (!auth.currentUser) {
                showMessage("Session expir√©e. Veuillez vous reconnecter.", 'error');
                return;
            }

            const firstName = getEl('force-first-name').value.trim();
            const lastName = getEl('force-last-name').value.trim();
            const newPassword = getEl('force-password').value;
            const confirmPassword = getEl('force-password-confirm').value;

            if (newPassword !== confirmPassword) {
                showMessage('Les mots de passe ne correspondent pas.', 'error');
                return;
            }

            try {
                await updatePassword(auth.currentUser, newPassword);
                const userDocRef = doc(usersCollection, auth.currentUser.uid);
                const displayName = `${firstName} ${lastName}`.trim();

                await updateDoc(userDocRef, {
                    firstName,
                    lastName,
                    displayName,
                    mustChangePassword: false,
                    updatedAt: new Date(),
                    firstLoginCompletedAt: new Date()
                });

                currentUserProfile = {
                    ...(currentUserProfile || {}),
                    firstName,
                    lastName,
                    displayName,
                    mustChangePassword: false
                };

                e.target.reset();

                showMessage('Mot de passe mis √† jour avec succ√®s.', 'success');
                initializeAppUI(currentUserRole || 'user', auth.currentUser.email);
            } catch (error) {
                console.error('Erreur mise √† jour mot de passe:', error);
                let message = "Impossible de mettre √† jour le mot de passe.";
                if (error.code === 'auth/requires-recent-login') {
                    message = "Veuillez vous reconnecter pour modifier votre mot de passe.";
                }
                showMessage(message, 'error');
            }
        }

        // Handler: Ajouter un magasin
        async function handleAddStore(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const name = getEl('store-name').value;
            const code = getEl('store-code').value;
            
            try {
                await addDoc(storesCollection, { name, code });
                showMessage(`Magasin "${name}" ajout√© !`, 'success');
                e.target.reset();
            } catch (error) {
                console.error("Erreur ajout magasin:", error);
                showMessage("Erreur lors de l'ajout du magasin.", "error");
            }
        }
        
        // Handler: Ajouter un appareil
        async function handleAddEquipment(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const storeId = getEl('equip-store-select').value;
            const name = getEl('equip-name').value;
            const type = getEl('equip-type').value;
            const formId = getEl('equip-form-select').value;
            
            if (!storeId || !formId || !type || !name) {
                showMessage("Veuillez remplir tous les champs.", "error");
                return;
            }

            try {
                await addDoc(equipmentCollection, {
                    storeId,
                    name,
                    type,
                    formId
                });
                
                showMessage(`Appareil "${name}" ajout√© !`, 'success');
                e.target.reset();
            } catch (error) {
                console.error("Erreur ajout appareil:", error);
                showMessage("Erreur lors de l'ajout de l'appareil.", "error");
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            if (!isAuthReady || currentUserRole !== 'admin') {
                showMessage("Action non autoris√©e.", 'error');
                return;
            }

            const firstName = getEl('create-user-first-name').value.trim();
            const lastName = getEl('create-user-last-name').value.trim();
            const email = getEl('create-user-email').value.trim().toLowerCase();
            const password = getEl('create-user-password').value;
            const role = getEl('create-user-role').value;

            if (!firstName || !lastName) {
                showMessage('Merci de renseigner le pr√©nom et le nom.', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('Le mot de passe provisoire doit contenir au moins 6 caract√®res.', 'error');
                return;
            }

            try {
                const adminAuth = getSecondaryAuthInstance();
                const userCredential = await createUserWithEmailAndPassword(adminAuth, email, password);
                const newUser = userCredential.user;

                const displayName = `${firstName} ${lastName}`.trim();
                await setDoc(doc(usersCollection, newUser.uid), {
                    email,
                    role,
                    fonction: '',
                    firstName,
                    lastName,
                    displayName,
                    mustChangePassword: true,
                    status: 'invited',
                    createdAt: new Date(),
                    createdBy: currentUserId || null
                });

                if (adminAuth.currentUser) {
                    await signOut(adminAuth);
                }

                e.target.reset();
                showMessage(`Compte cr√©√© pour ${displayName}.`, 'success');
            } catch (error) {
                console.error('Erreur cr√©ation utilisateur:', error);
                let message = "Impossible de cr√©er cet utilisateur.";
                if (error.code === 'auth/email-already-in-use') {
                    message = "Cet email est d√©j√† associ√© √† un compte.";
                }
                showMessage(message, 'error');
            }
        }
        
        // Handler: Clics sur la liste des magasins (d√©l√©gation)
        async function handleStoresListClick(e) {
            const target = e.target;
            if (!isAuthReady) return;

            const toggleBtn = target.closest('.store-toggle');
            if (toggleBtn) {
                const storeId = toggleBtn.dataset.storeId;
                if (openStoreIds.has(storeId)) {
                    openStoreIds.delete(storeId);
                } else {
                    openStoreIds.add(storeId);
                }
                renderStoresList();
                return;
            }

            // --- Modifier Magasin ---
            if (target.classList.contains('edit-store-btn')) {
                const storeId = target.dataset.storeId;
                const store = allStores.find(s => s.id === storeId);
                if (store) {
                    getEl('edit-store-id').value = store.id;
                    getEl('edit-store-name').value = store.name;
                    getEl('edit-store-code').value = store.code;
                    getEl('edit-store-modal').classList.remove('hidden');
                }
            }
            
            // --- Supprimer Magasin ---
            if (target.classList.contains('delete-store-btn')) {
                const storeId = target.dataset.storeId;
                const store = allStores.find(s => s.id === storeId);
                if (store) {
                    showConfirmationModal(
                        `Supprimer ${store.name} ?`,
                        "Cela supprimera le magasin ET tous les appareils associ√©s.",
                        async () => {
                            try {
                                const storeRef = doc(storesCollection, storeId);
                                const storeSnapshot = await getDoc(storeRef);
                                if (!storeSnapshot.exists()) {
                                    showMessage('Magasin introuvable.', 'error');
                                    return;
                                }

                                const storeData = storeSnapshot.data();
                                const q = query(equipmentCollection, where("storeId", "==", storeId));
                                const querySnapshot = await getDocs(q);

                                const equipmentData = querySnapshot.docs.map(docSnap => ({
                                    id: docSnap.id,
                                    data: docSnap.data()
                                }));

                                const batch = writeBatch(db);
                                querySnapshot.forEach(docSnap => batch.delete(docSnap.ref));
                                batch.delete(storeRef);
                                await batch.commit();

                                openStoreIds.delete(storeId);
                                equipmentData.forEach(item => selectedEquipmentIds.delete(item.id));
                                updateBulkActionBar();

                                showMessage("Magasin et appareils supprim√©s.", "success", {
                                    actionLabel: 'Annuler',
                                    duration: 5000,
                                    onAction: async () => {
                                        const restoreBatch = writeBatch(db);
                                        restoreBatch.set(storeRef, storeData);
                                        equipmentData.forEach(item => {
                                            restoreBatch.set(doc(equipmentCollection, item.id), item.data);
                                        });
                                        await restoreBatch.commit();
                                        showMessage('Suppression annul√©e.', 'success');
                                    }
                                });
                            } catch (error) {
                                console.error("Erreur suppression magasin:", error);
                                showMessage("Erreur lors de la suppression.", "error");
                            }
                        }
                    );
                }
            }

            // --- Modifier Appareil ---
            if (target.classList.contains('edit-equip-btn')) {
                const equipId = target.dataset.equipId;
                const equip = allEquipment.find(e => e.id === equipId);
                if (equip) {
                    getEl('edit-equip-id').value = equip.id;
                    getEl('edit-equip-name').value = equip.name;
                    getEl('edit-equip-form-select').value = equip.formId;
                    getEl('edit-equip-modal').classList.remove('hidden');
                }
            }
            
            // --- Supprimer Appareil ---
            if (target.classList.contains('delete-equip-btn')) {
                const equipId = target.dataset.equipId;
                const equip = allEquipment.find(e => e.id === equipId);
                if (equip) {
                     showConfirmationModal(
                        `Supprimer ${equip.name} ?`,
                        "L'appareil sera supprim√© de ce magasin.",
                        async () => {
                            try {
                                const equipRef = doc(equipmentCollection, equipId);
                                const snapshot = await getDoc(equipRef);
                                if (!snapshot.exists()) {
                                    showMessage('Appareil introuvable.', 'error');
                                    return;
                                }

                                const equipData = snapshot.data();

                                await deleteDoc(equipRef);

                                selectedEquipmentIds.delete(equipId);
                                updateBulkActionBar();

                                showMessage("Appareil supprim√©.", "success", {
                                    actionLabel: 'Annuler',
                                    duration: 5000,
                                    onAction: async () => {
                                        await setDoc(equipRef, equipData);
                                        showMessage('Suppression annul√©e.', 'success');
                                    }
                                });
                            } catch (error) {
                                console.error("Erreur suppression appareil:", error);
                                showMessage("Erreur lors de la suppression.", "error");
                            }
                        }
                    );
                }
            }
            
            // --- G√©n√©rer QR Code (Simple) ---
            const qrBtn = e.target.closest('.generate-qr-btn');
            if (qrBtn) {
                const data = {
                    equipmentId: qrBtn.dataset.equipId,
                    storeId: qrBtn.dataset.storeId,
                    formId: qrBtn.dataset.formId
                };
                
                // NOUVEAU: Passer les noms
                generateSingleQrCode(data, qrBtn.dataset.equipName, qrBtn.dataset.storeName);
            }
        }
        
        // Handler: Soumettre l'√©dition de magasin
        async function handleEditStore(e) {
            e.preventDefault();
            if (!isAuthReady) return;
            
            const storeId = getEl('edit-store-id').value;
            const newName = getEl('edit-store-name').value;
            const newCode = getEl('edit-store-code').value;
            
            try {
                const storeRef = doc(storesCollection, storeId);
                await updateDoc(storeRef, { name: newName, code: newCode });
                
                getEl('edit-store-modal').classList.add('hidden');
                showMessage("Magasin mis √† jour.", "success");
            } catch (error) {
                console.error("Erreur M√†J magasin:", error);
                showMessage("Erreur lors de la mise √† jour.", "error");
            }
        }
        
        // Handler: Soumettre l'√©dition d'appareil
        async function handleEditEquipment(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const equipId = getEl('edit-equip-id').value;
            const newName = getEl('edit-equip-name').value;
            const newFormId = getEl('edit-equip-form-select').value;

            try {
                const equipRef = doc(equipmentCollection, equipId);
                await updateDoc(equipRef, {
                    name: newName,
                    formId: newFormId
                });
                
                getEl('edit-equip-modal').classList.add('hidden');
                showMessage("Appareil mis √† jour.", "success");
            } catch (error) {
                console.error("Erreur M√†J appareil:", error);
                showMessage("Erreur lors de la mise √† jour.", "error");
            }
        }
        
        // Handler: Clics sur la liste des formulaires (d√©l√©gation)
        function handleFormsListClick(e) {
            const target = e.target;
            if (!isAuthReady) return;
            
            const formId = target.dataset.formId;
            const form = allForms.find(f => f.id === formId);
            if (!form) return;

            // --- Modifier Formulaire ---
            if (target.classList.contains('edit-form-btn')) {
                getEl('form-builder-id').value = form.id;
                getEl('form-builder-title').value = form.title;
                
                const fieldsContainer = getEl('form-builder-fields');
                fieldsContainer.innerHTML = ''; // Vider les anciens
                
                form.fields.forEach(field => {
                    addFormFieldToBuilder(fieldsContainer, field);
                });
                
                getEl('cancel-edit-form-btn').classList.remove('hidden');
                window.scrollTo(0, 0); // Remonter en haut de page
            }
            
            // --- Supprimer Formulaire ---
            if (target.classList.contains('delete-form-btn')) {
                showConfirmationModal(
                    `Supprimer ${form.title} ?`,
                    "Les appareils li√©s n'auront plus de formulaire (cela peut causer des erreurs).",
                    async () => {
                        try {
                            const formRef = doc(formsCollection, formId);
                            const snapshot = await getDoc(formRef);
                            if (!snapshot.exists()) {
                                showMessage('Formulaire introuvable.', 'error');
                                return;
                            }

                            const formData = snapshot.data();
                            await deleteDoc(formRef);

                            showMessage("Formulaire supprim√©.", "success", {
                                actionLabel: 'Annuler',
                                duration: 5000,
                                onAction: async () => {
                                    await setDoc(formRef, formData);
                                    showMessage('Suppression annul√©e.', 'success');
                                }
                            });
                        } catch (error) {
                            console.error("Erreur suppression formulaire:", error);
                            showMessage("Erreur lors de la suppression.", "error");
                        }
                    }
                );
            }
        }
        
        // Handler: Sauvegarder un formulaire (cr√©er ou modifier)
        async function handleSaveForm(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const formId = getEl('form-builder-id').value;
            const title = getEl('form-builder-title').value;
            const fields = [];
            
            document.querySelectorAll('#form-builder-fields .form-builder-field').forEach(fieldDiv => {
                const label = fieldDiv.querySelector('[data-key="label"]').value;
                const type = fieldDiv.querySelector('[data-key="type"]').value;
                const required = fieldDiv.querySelector('[data-key="required"]').checked;
                
                const optionInputs = fieldDiv.querySelectorAll('.option-input');
                const optionsArray = Array.from(optionInputs)
                                          .map(input => input.value.trim())
                                          .filter(opt => opt.length > 0);
                const options = optionsArray.join(',');
                
                if (label) {
                    fields.push({ label, type, required, options });
                }
            });

            if (fields.length === 0) {
                showMessage("Un formulaire doit avoir au moins un champ.", "error");
                return;
            }
            
            const formData = { title, fields };

            try {
                if (formId) {
                    // Modification
                    const docRef = doc(formsCollection, formId);
                    await updateDoc(docRef, formData);
                    showMessage(`Formulaire "${title}" mis √† jour !`, 'success');
                } else {
                    // Cr√©ation
                    await addDoc(formsCollection, formData);
                    showMessage(`Formulaire "${title}" cr√©√© !`, 'success');
                }
                
                resetFormBuilder();
            } catch (error) {
                console.error("Erreur sauvegarde formulaire:", error);
                showMessage("Erreur lors de la sauvegarde du formulaire.", "error");
            }
        }
        
        // Handler: Soumettre le formulaire d'intervention
        async function handleSubmitIntervention(e) {
            e.preventDefault();
            if (!isAuthReady || !currentScannedData) return;
            
            const formData = {};
            const form = allForms.find(f => f.id === currentScannedData.formId);
            
            if (!form) {
                showMessage("Erreur: Formulaire de r√©f√©rence introuvable.", "error");
                return;
            }
            
            // R√©cup√©rer les donn√©es des champs dynamiques
            for (const field of form.fields) {
                const fieldName = field.label;
                const fieldId = `form-field-${fieldName.replace(/\s+/g, '-')}`;
                let value = null;
                let isRequired = field.required;

                switch (field.type) {
                    case 'checkbox':
                        const checkedBoxes = document.querySelectorAll(`input[name="${fieldName}"]:checked`);
                        value = Array.from(checkedBoxes).map(cb => cb.value);
                        if (isRequired && value.length === 0) {
                            showMessage(`Le champ "${fieldName}" est obligatoire (au moins 1 choix).`, 'error');
                            return;
                        }
                        break;
                    case 'radio':
                        const checkedRadio = document.querySelector(`input[name="${fieldName}"]:checked`);
                        value = checkedRadio ? checkedRadio.value : null;
                        break;
                    default: // Text, Textarea, Number, Select
                        const input = document.getElementById(fieldId);
                        value = input ? input.value : null;
                }
                
                if (field.type !== 'checkbox' && isRequired && !value) {
                    showMessage(`Le champ "${fieldName}" est obligatoire.`, 'error');
                    return; // Arr√™ter la soumission
                }
                
                formData[fieldName] = value;
            }
            
            try {
                await addDoc(reportsCollection, {
                    userId: currentUserId,
                    userEmail: auth.currentUser.email,
                    storeId: currentScannedData.storeId,
                    equipmentId: currentScannedData.equipmentId,
                    formId: currentScannedData.formId,
                    timestamp: new Date(), 
                    data: formData
                });
                
                showMessage("Rapport soumis avec succ√®s !", "success");
                navigateTo('scanner'); // Retour √† la page de scan
                currentScannedData = null; // R√©initialiser
                e.target.reset();
            } catch (error) {
                console.error("Erreur soumission rapport:", error);
                showMessage("Erreur lors de la soumission du rapport.", "error");
            }
        }
        
        // Handler: Clics sur la liste des utilisateurs (d√©l√©gation)
        async function handleUsersListClick(e) {
            // Sauvegarder
            if (e.target.classList.contains('save-user-btn')) {
                const userId = e.target.dataset.userId;
                if (userId === currentUserId) return;

                const userRow = e.target.closest('.user-row');
                const newRole = userRow.querySelector('[data-key="role"]').value;
                const newFonction = userRow.querySelector('[data-key="fonction"]').value.trim();
                const newFirstName = userRow.querySelector('[data-key="firstName"]').value.trim();
                const newLastName = userRow.querySelector('[data-key="lastName"]').value.trim();
                const displayName = `${newFirstName} ${newLastName}`.trim();

                try {
                    const userDocRef = doc(usersCollection, userId);
                    await updateDoc(userDocRef, {
                        role: newRole,
                        fonction: newFonction,
                        firstName: newFirstName,
                        lastName: newLastName,
                        displayName,
                        updatedAt: new Date()
                    });
                    showMessage("Utilisateur mis √† jour.", "success");
                } catch (error) {
                     console.error("Erreur M√†J utilisateur:", error);
                     showMessage("Erreur lors de la mise √† jour.", "error");
                }
            }

            if (e.target.classList.contains('force-reset-btn')) {
                const userId = e.target.dataset.userId;
                if (userId === currentUserId) {
                    showMessage("Impossible de vous demander une r√©initialisation.", 'error');
                    return;
                }

                try {
                    const userDocRef = doc(usersCollection, userId);
                    await updateDoc(userDocRef, {
                        mustChangePassword: true,
                        updatedAt: new Date()
                    });
                    showMessage("L'utilisateur devra changer son mot de passe √† la prochaine connexion.", 'success');
                } catch (error) {
                    console.error("Erreur forcer r√©initialisation:", error);
                    showMessage("Impossible de forcer la r√©initialisation.", 'error');
                }
            }

            // Supprimer
            if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.dataset.userId;
                if (userId === currentUserId) return;

                const userRow = e.target.closest('.user-row');
                const userEmail = userRow ? (userRow.dataset.userEmail || '') : '';

                showConfirmationModal(
                    `Supprimer ${userEmail} ?`,
                    "Cela supprime l'enregistrement de l'utilisateur. (Ne supprime pas l'authentification).",
                    async () => {
                        try {
                            const userRef = doc(usersCollection, userId);
                            const snapshot = await getDoc(userRef);
                            if (!snapshot.exists()) {
                                showMessage('Utilisateur introuvable.', 'error');
                                return;
                            }

                            const userData = snapshot.data();

                            await deleteDoc(userRef);

                            showMessage("Utilisateur supprim√© de la base de donn√©es.", "success", {
                                actionLabel: 'Annuler',
                                duration: 5000,
                                onAction: async () => {
                                    await setDoc(userRef, userData);
                                    showMessage('Suppression annul√©e.', 'success');
                                }
                            });
                        } catch (error) {
                            console.error("Erreur suppression utilisateur:", error);
                            showMessage("Erreur lors de la suppression.", "error");
                        }
                    }
                )
            }
        }
        
        // Handler: Afficher onglet admin 'Mod√®le'
        function showAdminTabModel() {
            getEl('tab-panel-model').classList.remove('hidden');
            getEl('tab-panel-manual').classList.add('hidden');
            getEl('tab-model-btn').classList.add('border-secondary', 'text-secondary');
            getEl('tab-manual-btn').classList.remove('border-secondary', 'text-secondary');
            getEl('tab-manual-btn').classList.add('border-transparent', 'text-gray-500');
        }
        
        // Handler: Afficher onglet admin 'Manuel'
        function showAdminTabManual() {
            getEl('tab-panel-model').classList.add('hidden');
            getEl('tab-panel-manual').classList.remove('hidden');
            getEl('tab-manual-btn').classList.add('border-secondary', 'text-secondary');
            getEl('tab-model-btn').classList.remove('border-secondary', 'text-secondary');
            getEl('tab-model-btn').classList.add('border-transparent', 'text-gray-500');
        }
        
        // Handler: Ajouter type d'appareil (Mod√®le)
        async function handleAddEquipTypeModel(e) {
            e.preventDefault();
            const selected = getEl('equip-type-model-select').value;
            if (!selected) return;
            
            const [label, emoji] = selected.split(',');
            
            try {
                await addDoc(equipmentTypesCollection, { label, emoji });
                showMessage("Type d'appareil (mod√®le) ajout√©.", "success");
            } catch (error) {
                console.error("Erreur ajout type:", error);
                showMessage("Erreur lors de l'ajout.", "error");
            }
        }
        
        // Handler: Ajouter type d'appareil (Manuel)
        async function handleAddEquipTypeManual(e) {
            e.preventDefault();
            const label = getEl('equip-type-label').value;
            const emoji = getEl('equip-type-emoji').value;
            
            try {
                await addDoc(equipmentTypesCollection, { label, emoji });
                showMessage("Type d'appareil ajout√©.", "success");
                e.target.reset();
            } catch (error) {
                console.error("Erreur ajout type:", error);
                showMessage("Erreur lors de l'ajout.", "error");
            }
        }
        
        // Handler: Clics sur la liste des types (d√©l√©gation)
        function handleEquipTypesListClick(e) {
            // Modifier
            if(e.target.classList.contains('edit-equip-type-btn')) {
                const typeId = e.target.dataset.typeId;
                const type = allEquipmentTypes.find(t => t.id === typeId);
                if (type) {
                    getEl('edit-equip-type-id').value = type.id;
                    getEl('edit-equip-type-label').value = type.label;
                    getEl('edit-equip-type-emoji').value = type.emoji;
                    getEl('edit-equip-type-modal').classList.remove('hidden');
                }
            }
            
            // Supprimer
            if(e.target.classList.contains('delete-equip-type-btn')) {
                const typeId = e.target.dataset.typeId;
                showConfirmationModal(
                    "Supprimer ce type ?",
                    "Assurez-vous qu'aucun appareil n'utilise ce type avant de le supprimer.",
                    async () => {
                        try {
                            const typeRef = doc(equipmentTypesCollection, typeId);
                            const snapshot = await getDoc(typeRef);
                            if (!snapshot.exists()) {
                                showMessage('Type introuvable.', 'error');
                                return;
                            }

                            const typeData = snapshot.data();
                            await deleteDoc(typeRef);

                            showMessage("Type supprim√©.", "success", {
                                actionLabel: 'Annuler',
                                duration: 5000,
                                onAction: async () => {
                                    await setDoc(typeRef, typeData);
                                    showMessage('Suppression annul√©e.', 'success');
                                }
                            });
                        } catch (error) {
                            console.error("Erreur suppression type:", error);
                            showMessage("Erreur lors de la suppression.", "error");
                        }
                    }
                )
            }
        }
        
        // Handler: Soumettre l'√©dition du type d'appareil
        async function handleEditEquipType(e) {
            e.preventDefault();
            const typeId = getEl('edit-equip-type-id').value;
            const newLabel = getEl('edit-equip-type-label').value;
            const newEmoji = getEl('edit-equip-type-emoji').value;
            
            try {
                const typeRef = doc(equipmentTypesCollection, typeId);
                await updateDoc(typeRef, { label: newLabel, emoji: newEmoji });
                getEl('edit-equip-type-modal').classList.add('hidden');
                showMessage("Type d'appareil mis √† jour.", "success");
            } catch (error) {
                console.error("Erreur M√†J type:", error);
                showMessage("Erreur lors de la mise √† jour.", "error");
            }
        }

        
        // --- NOUVELLE SECTION: Actions de Masse (Bulk Actions) ---

        // G√®re le cochage/d√©cochage d'un appareil
        function handleEquipSelectChange(e) {
            if (!e.target.classList.contains('equip-select-checkbox')) return;
            
            const equipId = e.target.dataset.equipId;
            if (e.target.checked) {
                selectedEquipmentIds.add(equipId);
            } else {
                selectedEquipmentIds.delete(equipId);
            }
            updateBulkActionBar();
        }

        // Met √† jour la barre d'actions (visible/cach√©e, compteur)
        function updateBulkActionBar() {
            const bar = getEl('bulk-action-bar');
            const count = selectedEquipmentIds.size;
            
            if (count > 0) {
                getEl('bulk-action-count').textContent = count;
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        }

        // G√®re le clic sur "Annuler" la s√©lection
        function handleDeselectAll() {
            selectedEquipmentIds.clear();
            document.querySelectorAll('.equip-select-checkbox:checked').forEach(cb => {
                cb.checked = false;
            });
            updateBulkActionBar();
        }

        // G√®re le clic sur "Imprimer QR" (Masse)
        function handleBulkPrintClick() {
            const bulkItems = Array.from(selectedEquipmentIds).map(id => {
                const equip = allEquipment.find(e => e.id === id);
                if (!equip) return null;
                const store = allStores.find(s => s.id === equip.storeId);
                return {
                    equipmentId: equip.id,
                    storeId: equip.storeId,
                    formId: equip.formId,
                    equipName: equip.name || 'Appareil',
                    storeName: store ? (store.name || 'Magasin') : 'Magasin inconnu'
                };
            }).filter(Boolean);

            if (bulkItems.length === 0) {
                showMessage('S√©lectionnez au moins un appareil avant d\'imprimer.', 'error');
                return;
            }

            currentBulkQrData = bulkItems;
            getEl('qr-modal-content').dataset.simpleData = '';
            renderBulkQrCodes();
        }

        function renderBulkQrCodes() {
            if (!currentBulkQrData || currentBulkQrData.length === 0) return;

            const modalContent = getEl('qr-modal-content');
            const size = parseInt(getEl('qr-size-select').value, 10) || 256;

            modalContent.innerHTML = '';
            modalContent.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 p-2';

            getEl('qr-modal-title').textContent = `Impression de ${currentBulkQrData.length} QR Code(s)`;
            getEl('qr-modal-subtitle').classList.add('hidden');
            getEl('qr-size-select-wrapper').classList.remove('hidden');

            currentBulkQrData.forEach(item => {
                const qrDivId = `qr-bulk-${item.equipmentId}`;
                const equipNameSafe = escapeHtml(item.equipName);
                const storeNameSafe = escapeHtml(item.storeName);
                const cardHtml = `
                    <div class="qr-grid-item text-center p-4 border rounded-lg break-inside-avoid">
                        <h4 class="text-xl font-bold mb-2">${equipNameSafe}</h4>
                        <p class="text-sm text-gray-600 mb-3">${storeNameSafe}</p>
                        <div id="${qrDivId}" class="flex justify-center"></div>
                    </div>
                `;
                modalContent.insertAdjacentHTML('beforeend', cardHtml);

                requestAnimationFrame(() => {
                    new QRCode(document.getElementById(qrDivId), {
                        text: JSON.stringify({
                            equipmentId: item.equipmentId,
                            storeId: item.storeId,
                            formId: item.formId
                        }),
                        width: size,
                        height: size,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                });
            });

            getEl('qr-modal').classList.remove('hidden');
        }
        
        // G√®re le clic sur "Supprimer" (Masse)
        function handleBulkDeleteClick() {
            const count = selectedEquipmentIds.size;
            showConfirmationModal(
                `Supprimer ${count} appareil(s) ?`,
                "Cette action est irr√©versible et supprimera tous les appareils s√©lectionn√©s.",
                async () => {
                    if (!isAuthReady) return;
                    try {
                        const docRefs = Array.from(selectedEquipmentIds).map(id => doc(equipmentCollection, id));
                        const snapshots = await Promise.all(docRefs.map(ref => getDoc(ref)));

                        const equipmentData = snapshots.filter(snap => snap.exists()).map(snap => ({
                            ref: snap.ref,
                            data: snap.data()
                        }));

                        const batch = writeBatch(db);
                        equipmentData.forEach(item => batch.delete(item.ref));
                        await batch.commit();

                        handleDeselectAll();

                        showMessage(`${count} appareil(s) supprim√©(s).`, "success", {
                            actionLabel: 'Annuler',
                            duration: 5000,
                            onAction: async () => {
                                const restoreBatch = writeBatch(db);
                                equipmentData.forEach(item => restoreBatch.set(item.ref, item.data));
                                await restoreBatch.commit();
                                showMessage('Suppression annul√©e.', 'success');
                            }
                        });
                    } catch (error) {
                        console.error("Erreur suppression de masse:", error);
                        showMessage("Erreur lors de la suppression.", "error");
                    }
                }
            );
        }

        // G√®re le clic sur "Dupliquer" (Masse)
        function handleBulkDuplicateClick() {
            const count = selectedEquipmentIds.size;
            getEl('duplicate-count').textContent = count;
            renderDuplicateModalStores();
            getEl('duplicate-equip-modal').classList.remove('hidden');
        }
        
        // Remplit la modale de duplication avec la liste des magasins
        function renderDuplicateModalStores() {
            const listContainer = getEl('duplicate-store-list');
            listContainer.innerHTML = '';
            
            if (allStores.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">Aucun magasin de destination disponible.</p>';
                return;
            }
            
            allStores.sort((a,b) => a.name.localeCompare(b.name)).forEach(store => {
                const storeHtml = `
                    <label class="flex items-center p-2 rounded-lg hover:bg-gray-100">
                        <input type="checkbox" name="targetStore" value="${store.id}" class="h-4 w-4 rounded mr-2">
                        <span>${store.name} (${store.code})</span>
                    </label>
                `;
                listContainer.insertAdjacentHTML('beforeend', storeHtml);
            });
        }
        
        // G√®re la soumission du formulaire de duplication
        async function handleSubmitDuplicate(e) {
            e.preventDefault();
            if (!isAuthReady) return;
            
            const targetStoreIds = Array.from(document.querySelectorAll('#duplicate-store-list input[name="targetStore"]:checked'))
                                      .map(cb => cb.value);
            
            if (targetStoreIds.length === 0) {
                showMessage("Veuillez s√©lectionner au moins un magasin de destination.", "error");
                return;
            }
            
            const itemsToDuplicate = Array.from(selectedEquipmentIds).map(id => {
                return allEquipment.find(e => e.id === id);
            }).filter(Boolean); // Filtrer les undefined
            
            if (itemsToDuplicate.length === 0) {
                 showMessage("Aucun appareil valide √† dupliquer.", "error");
                 return;
            }

            try {
                const batch = writeBatch(db);
                
                targetStoreIds.forEach(storeId => {
                    itemsToDuplicate.forEach(item => {
                        // Cr√©er une copie de l'objet, changer le storeId, supprimer l'id
                        const newEquip = { ...item };
                        delete newEquip.id; // Laisser Firestore g√©n√©rer un nouvel ID
                        newEquip.storeId = storeId;
                        
                        // Cr√©er une nouvelle r√©f√©rence de document
                        const newDocRef = doc(collection(db, equipmentCollection.path));
                        batch.set(newDocRef, newEquip);
                    });
                });
                
                await batch.commit();
                
                showMessage(`Appareil(s) dupliqu√©(s) dans ${targetStoreIds.length} magasin(s).`, "success");
                getEl('duplicate-equip-modal').classList.add('hidden');
                handleDeselectAll();

            } catch (error) {
                console.error("Erreur duplication de masse:", error);
                showMessage("Erreur lors de la duplication.", "error");
            }
        }
        
        // --- Fin de la section Actions de Masse ---
        
        // --- Fonctions pour le Form Builder ---
        function resetFormBuilder() {
            getEl('form-builder-id').value = '';
            getEl('create-form-builder').reset();
            getEl('form-builder-fields').innerHTML = '';
            getEl('cancel-edit-form-btn').classList.add('hidden');
        }
        
        function addFormFieldToBuilder(container, fieldData = {}) {
            const fieldIndex = container.children.length + Math.random();
            const label = fieldData.label || '';
            const type = fieldData.type || 'text';
            const required = fieldData.required || false;
            
            const optionsArray = (fieldData.options || "").split(',').filter(opt => opt.length > 0);
            const showOptions = ['select', 'radio', 'checkbox'].includes(type);

            const optionsHtml = optionsArray.map(opt => `
                <div class="flex items-center space-x-2 option-item">
                    <input type="text" class="form-field text-sm flex-1 option-input" value="${opt}">
                    <button type="button" class="remove-option-btn text-danger text-lg font-bold" title="Supprimer">&times;</button>
                </div>
            `).join('');

            const fieldHtml = `
                <div class="form-builder-field border p-3 rounded-md bg-gray-50 space-y-2 relative">
                    <button type="button" class="remove-field-btn absolute top-2 right-2 text-danger hover:text-red-700 font-bold text-lg" title="Supprimer ce champ">&times;</button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-600">Nom du champ</label>
                            <input type="text" placeholder="ex: Probl√®me constat√©" class="form-field text-sm" data-key="label" value="${label}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600">Type de champ</label>
                            <select class="form-field custom-select text-sm" data-key="type">
                                <option value="text" ${type === 'text' ? 'selected' : ''}>Texte (une ligne)</option>
                                <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>Texte (plusieurs lignes)</option>
                                <option value="number" ${type === 'number' ? 'selected' : ''}>Nombre</option>
                                <option value="select" ${type === 'select' ? 'selected' : ''}>Liste d√©roulante</option>
                                <option value="radio" ${type === 'radio' ? 'selected' : ''}>Choix unique (radio)</option>
                                <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>Choix multiples (checkbox)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="options-container ${showOptions ? '' : 'hidden'} space-y-2">
                        <label class="block text-sm font-medium text-gray-600">Options</label>
                        <div class="options-list space-y-2">
                            ${optionsHtml}
                        </div>
                        <button type="button" class="add-option-btn text-sm bg-gray-200 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-300">+ Ajouter une option</button>
                    </div>
                    
                    <div class="flex items-center pt-1">
                        <input type="checkbox" id="required-${fieldIndex}" class="h-4 w-4 rounded" data-key="required" ${required ? 'checked' : ''}>
                        <label for="required-${fieldIndex}" class="ml-2 text-sm">Obligatoire ?</label>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', fieldHtml);
        }
        
        function handleRemoveField(e) {
            e.target.closest('.form-builder-field').remove();
        }
        
        function handleAddOption(e) {
            const optionsList = e.target.previousElementSibling; // Le .options-list
            if (optionsList) {
                const optionHtml = `
                <div class="flex items-center space-x-2 option-item">
                    <input type="text" class="form-field text-sm flex-1 option-input" placeholder="Nouvelle option">
                    <button type="button" class="remove-option-btn text-danger text-lg font-bold" title="Supprimer">&times;</button>
                </div>`;
                optionsList.insertAdjacentHTML('beforeend', optionHtml);
            }
        }

        function handleRemoveOption(e) {
            e.target.closest('.option-item').remove();
        }
        
        function handleFieldTypeChange(e) {
            if (e.target.dataset.key === 'type') {
                const fieldDiv = e.target.closest('.form-builder-field');
                const optionsContainer = fieldDiv.querySelector('.options-container');
                const selectedType = e.target.value;
                
                if (['select', 'radio', 'checkbox'].includes(selectedType)) {
                    optionsContainer.classList.remove('hidden');
                } else {
                    optionsContainer.classList.add('hidden');
                }
            }
        }
        
        
        // --- Scanner et QR Code ---

        function startScan() {
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                html5QrCode.start( { facingMode: "environment" }, config, onScanSuccess, onScanError)
                .catch(err => {
                    showMessage("Impossible de d√©marrer la cam√©ra.", "error");
                });
                
                getEl('start-scan-btn').classList.add('hidden');
                getEl('stop-scan-btn').classList.remove('hidden');
            } catch (e) {
                 console.error("Erreur d√©marrage scanner:", e);
                 showMessage("Erreur au d√©marrage du scanner.", "error");
            }
        }

        function stopScan() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.warn("Erreur √† l'arr√™t du scan:", err));
            }
            getEl('start-scan-btn').classList.remove('hidden');
            getEl('stop-scan-btn').classList.add('hidden');
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code scann√©: ${decodedText}`);
            
            try {
                const data = JSON.parse(decodedText);
                const store = allStores.find(s => s.id === data.storeId);
                const equipment = allEquipment.find(eq => eq.id === data.equipmentId);
                const form = allForms.find(f => f.id === data.formId);

                if (store && equipment && form) {
                    currentScannedData = data;
                    
                    stopScan(); 
                    
                    getEl('form-subtitle').textContent = `Magasin: ${store.name}`;
                    getEl('form-datetime').value = new Date().toLocaleString('fr-FR');
                    
                    renderInterventionForm(data.formId);
                    navigateTo('intervention-form');

                } else {
                    showMessage("QR code non valide ou donn√©es introuvables.", "error");
                }
            } catch (err) {
                console.error(err);
                showMessage("Erreur lors de la lecture du QR code.", "error");
            }
        }

        function onScanError(errorMessage) {
            // Ignorer (trop verbeux)
        }

        // Modifi√© pour g√©rer la g√©n√©ration d'un *seul* QR Code
        function generateSingleQrCode(data, equipName, storeName) {
            const qrDataString = JSON.stringify(data);
            const qrContainer = getEl('qr-modal-content');
            const size = parseInt(getEl('qr-size-select').value) || 256;

            qrContainer.innerHTML = ''; // Nettoyer l'ancien
            qrContainer.className = 'flex justify-center flex-col items-center'; // Classe par d√©faut

            // Stocker les donn√©es pour le redimensionnement
            qrContainer.dataset.simpleData = JSON.stringify({ data, equipName, storeName });
            currentBulkQrData = [];

            // Afficher les contr√¥les du simple
            getEl('qr-size-select-wrapper').classList.remove('hidden');
            getEl('qr-modal-subtitle').classList.remove('hidden');
            getEl('qr-modal-title').textContent = "QR Code de l'Appareil"; // Titre par d√©faut
            
            // Mettre √† jour le sous-titre
            getEl('qr-modal-subtitle').textContent = `Appareil: ${equipName} | Magasin: ${storeName}`;

            // Cr√©er le div pour le QR code
            const qrDiv = document.createElement('div');
            
            new QRCode(qrDiv, {
                text: qrDataString,
                width: size,
                height: size,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            qrContainer.appendChild(qrDiv);
            getEl('qr-modal').classList.remove('hidden');
        }
        
        // --- Modals Utilitaires ---

        function showConfirmationModal(title, text, callback) {
            getEl('confirm-title').textContent = title;
            getEl('confirm-text').textContent = text;
            _confirmCallback = callback; // Stocker le callback
            getEl('confirm-modal').classList.remove('hidden');
        }

        function showMessage(message, type = 'error', options = {}) {
            const modal = getEl('message-modal');
            const text = getEl('message-text');
            const actionBtn = getEl('message-action-btn');
            if (!modal || !text) return;

            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
                messageTimeoutId = null;
            }

            text.textContent = message;

            if (type === 'success') {
                modal.classList.remove('bg-red-600');
                modal.classList.add('bg-green-600');
            } else {
                modal.classList.add('bg-red-600');
                modal.classList.remove('bg-green-600');
            }

            if (actionBtn) {
                actionBtn.classList.add('hidden');
            }
            messageActionHandler = null;

            if (actionBtn && options && options.actionLabel && typeof options.onAction === 'function') {
                actionBtn.textContent = options.actionLabel;
                actionBtn.classList.remove('hidden');
                messageActionHandler = options.onAction;
            }

            modal.classList.remove('hidden');
            modal.classList.add('opacity-100');

            const duration = options && options.duration ? options.duration : 3000;
            messageTimeoutId = setTimeout(() => {
                hideMessageModal();
            }, duration);
        }

        function hideMessageModal() {
            const modal = getEl('message-modal');
            const actionBtn = getEl('message-action-btn');
            if (!modal) return;

            modal.classList.add('hidden');
            modal.classList.remove('opacity-100');

            if (actionBtn) {
                actionBtn.classList.add('hidden');
            }

            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
                messageTimeoutId = null;
            }

            messageActionHandler = null;
        }
        
        // --- Navigation et Utilitaires ---
        
        function hideAllPages() {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
        }

        function navigateTo(pageId) {
            hideAllPages();
            
            const targetPage = getEl(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            } else {
                getEl('page-scanner').classList.remove('hidden');
                pageId = 'scanner';
            }

            // Mettre √† jour l'√©tat des onglets de navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.dataset.page === pageId) {
                    tab.classList.add('nav-tab-active');
                    tab.classList.remove('nav-tab-inactive');
                } else {
                    tab.classList.remove('nav-tab-active');
                    tab.classList.add('nav-tab-inactive');
                }
            });
            
            if (pageId !== 'scanner' && html5QrCode && html5QrCode.isScanning) {
                 stopScan();
            }
        }
        
        // D√©marrage de l'application
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>

</body>
</html>